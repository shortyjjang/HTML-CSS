$(function() {
    var $px;
    var window_height = $(window).height();
    function refreshParallaxator() {
        if ($px == null) {
          $px = $(".parallaxator");
        }
        $px.each(function() {
            var holder = this;
            var holder_bounding = holder.getBoundingClientRect();
            var HOLDER_IS_WITHIN_WINDOW = holder_bounding.top < window_height && holder_bounding.bottom > 0;

            var $holder = $(holder);
            if (HOLDER_IS_WITHIN_WINDOW) {
                $holder.find(".parallax_child").each(function() {
                    var child = this;
                    var $child = $(child);
                    var child_bounding = child.getBoundingClientRect();
                    var height_difference = holder_bounding.height - child_bounding.height;
                    var height_calc, top_calc, multiplier_inside, multiplier_outside, offset;
                    var velocity =
                        typeof $child.attr("data-parallaxator-velocity") != "undefined"
                            ? parseFloat($child.attr("data-parallaxator-velocity"))
                            : 1.0;

                    var CHILD_IS_SMALLER_THAN_HOLDER = child_bounding.height < holder_bounding.height;
                    var CHILD_IS_LARGER_THAN_HOLDER = child_bounding.height >= holder_bounding.height;
                    var CHILD_IS_SMALLER_THAN_WINDOW = child_bounding.height < window_height;
                    var CHILD_IS_LARGER_THAN_WINDOW = child_bounding.height >= window_height;
                    var HOLDER_IS_SMALLER_THAN_WINDOW = holder_bounding.height < window_height;

                    // Inside multiplier calculation
                    height_calc = window_height - holder_bounding.height;
                    top_calc = (holder_bounding.top - height_calc) * -1;
                    multiplier_inside = (top_calc / height_calc - 0.5) * velocity + 0.5;
                    // Outside multiplier calculation
                    height_calc = window_height + holder_bounding.height;
                    top_calc = (holder_bounding.top - window_height) * -1;
                    multiplier_outside = (top_calc / height_calc - 0.5) * velocity + 0.5;

                    if (CHILD_IS_SMALLER_THAN_HOLDER && CHILD_IS_SMALLER_THAN_WINDOW) {
                        if (HOLDER_IS_SMALLER_THAN_WINDOW) {
                            offset = height_difference * (multiplier_inside * -1) + height_difference;
                        } else {
                            offset = height_difference * (multiplier_inside * -1) + height_difference;
                            offset = height_difference * multiplier_inside;
                        }
                    } else if (CHILD_IS_LARGER_THAN_HOLDER && CHILD_IS_SMALLER_THAN_WINDOW) {
                        offset = height_difference * (multiplier_inside * -1) + height_difference;
                    } else if (CHILD_IS_LARGER_THAN_HOLDER && CHILD_IS_LARGER_THAN_WINDOW) {
                        offset =
                            (child_bounding.height + holder_bounding.height) * multiplier_outside -
                            child_bounding.height;
                    } else if (CHILD_IS_SMALLER_THAN_HOLDER && CHILD_IS_LARGER_THAN_WINDOW) {
                        offset =
                            (child_bounding.height + holder_bounding.height) * multiplier_outside -
                            child_bounding.height;
                    } else {
                    }
                    $child.addClass("_active");
                    $child.css("transform", "translate3d(0, " + offset + "px, 0)");
                });
            } else {
                $holder.find(".parallax_child._active").removeClass("_active");
            }
        });
    }

    function isMobile() {
        return navigator.userAgent.match(/(iPod|iPhone|iPad)/) && navigator.userAgent.match(/AppleWebKit/);
    }

    if (isMobile()) {
      var running = false;
      var cancellingId = null;
      // make service running all the time
      requestAnimationFrame(function next() {
        if (running === true) {
          refreshParallaxator();
        }
        requestAnimationFrame(next);
      });

      $(window).on("resize load ready", refreshParallaxator)
        .on("touchstart", function () {
          if (running === false) {
            running = true;
          }
        })
        .on("scroll", function () {
          running = true;
          // lazily determines if no scroll detected in 1s it's the last scroll for sure.
          var newCancellingId = setTimeout(function() {
            if (newCancellingId === cancellingId) {
              running = false;
            }
          }, 1000);
          cancellingId = newCancellingId;
        });
    } else {
      $(window).on("scroll resize load ready", refreshParallaxator);
    }
    $(".parallaxator img").load(refreshParallaxator);
});
