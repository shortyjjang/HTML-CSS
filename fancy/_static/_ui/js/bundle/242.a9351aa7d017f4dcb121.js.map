{"version":3,"sources":["webpack://fancy/./_static/modules/ui/article-admin/MediumEditorInsertPluginFancy.js"],"names":["boundFactory","$","Handlebars","MediumEditor","this","template","container","depth0","helpers","partials","data","helper","escapeExpression","placeholder","helperMissing","call","nullContext","stack1","each","styles","program","noop","label","alias1","alias2","alias3","key","actions","html","alias4","img","caption","progress","window","document","undefined","pluginName","defaults","editor","enabled","addons","images","embeds","ucfirst","str","charAt","toUpperCase","slice","parseVideo","url","match","RegExp","$3","indexOf","type","id","$6","Core","el","options","$el","templates","MediumInsert","Templates","extend","_defaults","_name","_serialize","serialize","_destroy","destroy","_setup","setup","_hideInsertButtons","hideButtons","editorSerialize","editorDestroy","editorSetup","getExtensionByName","updatePlaceholder","editorUpdatePlaceholder","getAdjacentCursor","$place","is","recoveryMode","cursor","before","closest","restoreCursor","recoveryObject","elToReplace","prepend","insertAfter","console","warn","prototype","init","addClass","Object","keys","length","disable","initAddons","clean","events","isWhitelabelV2","productCardTemplate","_","trim","productSlideshowTemplate","$insertProductDialog","dialog","$obj","selectedTemplate","find","searchedTemplate","$searched","$selected","Sortable","create","get","handle","ThingCache","searchCache","ref","selectedItemIds","on","debounce","e","dfd","val","target","value","Deferred","resolve","REST_API_ENDPOINT","keyword","then","things","empty","products","show","forEach","thing","sid","append","cached","hide","fail","xhr","status","alertify","alert","trigger","tpl","ids","map","i","Number","attr","toArray","items","clone","updatingRoot","replaceWith","close","push","cnt","text","sidToDelete","remove","filter","$root","_selectedItemIds","jQueryPromiseAll","arrayOfPromises","jQuery","when","apply","Array","arguments","promise","ctx","image","sales","src","brand_name","seller","title","price","thumbnail","args","end","setTimeout","t","positionButtons","showButtons","activeInsertAdded","resetOptionV2","hideOptionPopupV2","that","adjustCaretBeforeInsertWidget","root","migrateExistingContent","next","after","moveCaret","checkSelectionActive","$anchorNode","getSelection","anchorNode","insertYoutubeOnEvent","input","vid","$videoElement","EditorControl","refresh","preventDefault","proxy","isVisible","toggleAddons","tb","getEditor","isDisplayed","hideToolbar","GalleryControl","uploadImages","nextImages","renderTo","control","instance","addImages","bind","prompt","focus","which","open","click","isSlide","hasClass","isList","$that","sort","a","b","one","$this","$slide","off","productSlide","itemPerSlide","center","$wrapper","$li","removingId","selectElement","showAndUpdateToolbar","body","$data","removeClass","elements","enable","dontShow","contents","children","not","nodeName","toLowerCase","hidePlaceholder","showPlaceholder","base","triggerInput","deselect","removeAllRanges","disableSelection","addon","addonName","$buttons","$lastEl","wrap","parent","addButtons","prev","getButtons","templateName","buttons","prop","css","toggleButtons","range","$current","$p","activeAddon","selection","rangeCount","getRangeAt","commonAncestorContainer","removeAttr","$lastCaption","elementsContainer","elementsContainerAbsolute","getComputedStyle","getPropertyValue","position","left","top","height","parseInt","scrollTop","$tools","toggle","hideAddons","addonAction","$a","currentTarget","action","meta","sel","textEl","createRange","childNodes","createTextNode","appendChild","setStart","collapse","addRange","addCaption","$newCaption","removeCaptions","$ignore","$captions","removeCaptionPlaceholder","$caption","$cl","insertBefore","fn","textareaId","siblings","oembedProxy","captions","captionPlaceholder","storeMeta","wide","right","clicked","$event","Event","parseOnPaste","Embeds","core","_serializePreEmbeds","$embeds","backwardsCompatibility","add","togglePlaceholder","fixRightClickOnPlaceholder","processLink","stopPropagation","oembed","parseUrl","processPasted","pastedUrl","originalEvent","clipboardData","getData","test","pasted","support","cors","ajax","crossDomain","cache","dataType","success","JSON","stringify","error","jqXHR","textStatus","errorThrown","responseJSON","parse","responseText","log","message","join","replace","embed","$div","nodeType","textContent","FB","XFBML","convertBadEmbed","content","$empty","$content","emptyTemplate","selectEmbed","$embed","addToolbar","unselectEmbed","removeEmbed","$toolbar","$toolbar2","toolbarContainer","active","first","repositionToolbars","fadeIn","autoRepositionToolbars","elementsContainerBoundary","getBoundingClientRect","containerWidth","width","offset","toolbarAction","$button","$lis","className","added","removed","toolbar2Action","callback","ImageModes","Full","Normal","Quoted","Grid","ImageModesEditClasses","ImageModesClasses","quotedPlaceHolderMsg","Util","deleteMethod","deleteScript","preview","autoGrid","fileUploadOptions","acceptFileTypes","fileDeleteOptions","grid","sorting","sortable","group","containerSelector","itemSelector","nested","vertical","afterMove","messages","acceptFileTypesError","maxFileSizeError","Images","$currentImage","FileReader","_serializePreImages","getImageMode","$image","changeMode","$fig","prevMode","nextMode","tempCaptionCallback","tempCaption","quote","$img","$images","ReactMediumEditor__changeMode","handleModeChange","event","$target","getAttribute","setAttribute","epochId","String","Date","popup","$grid","image_url","serialziedImages","organizeImageService","organizedImages","original","$cap","$file","done","XMLHttpRequest","upload","progressall","fileupload","uploadAdd","reader","uploadErrors","file","files","maxFileSize","name","size","uploadFailed","autoUpload","process","onload","result","readAsDataURL","submit","uploadProgressall","$progressbar","loaded","total","uploadProgress","context","uploadDone","uiid","showImage","additionals","__SECRET__","domImage","isGrid","getDOMImage","uploadCompleted","blankUrl","load","expanded","appendTo","style","Image","selectImage","blur","unselectImage","removeImage","$parent","current","caretPosition","$sibling","selectedHtml","$selectedImage","getCaretOffsets","getSelectionHtml","deleteFile","$tpl","util","require"],"mappings":"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","file":"242.a9351aa7d017f4dcb121.js","sourcesContent":["/*! \n * medium-editor-insert-plugin v2.4.0 - jQuery insert plugin for MediumEditor\n *\n * http://linkesch.com/medium-editor-insert-plugin\n * \n * Copyright (c) 2014 Pavel Linkesch (http://linkesch.com)\n * Released under the MIT license\n */\n\nvar define = false;\n(function (factory) {\n    var boundFactory = factory.bind(window);  // Due to strict mode, manually bind `thisContext` to window.\n    // if (typeof define === 'function' && define.amd) {\n    //     define(['jquery', 'handlebars/runtime', 'medium-editor', 'blueimp-file-upload', 'jquery-sortable'], boundFactory);\n    // } else if (typeof module === 'object' && module.exports) {\n        // module.exports = function (jQuery) {\n            // if (typeof window === 'undefined') {\n            //     throw new Error(\"medium-editor-insert-plugin runs only in a browser.\")\n            // }\n            window.Handlebars = require('handlebars/runtime');\n            window.MediumEditor = require('medium-editor');\n            require('jquery-sortable');\n            require('blueimp-file-upload');\n\n            boundFactory(jQuery, Handlebars, MediumEditor);\n            // return jQuery;\n        // };\n    // } else {\n    //     boundFactory(jQuery, Handlebars, MediumEditor);\n    // }\n}(function ($, Handlebars, MediumEditor) {\n\nthis[\"MediumInsert\"] = this[\"MediumInsert\"] || {};\nthis[\"MediumInsert\"][\"Templates\"] = this[\"MediumInsert\"][\"Templates\"] || {};\n\nthis[\"MediumInsert\"][\"Templates\"][\"src/js/templates/core-buttons-gear.hbs\"] = Handlebars.template({\"compiler\":[7,\">= 4.0.0\"],\"main\":function(container,depth0,helpers,partials,data) {\n    return \"<div class=\\\"add_option medium-insert-buttons whitelabel-gear\\\" contenteditable=\\\"false\\\">\\n  <small class=\\\"add_option_tools\\\" style=\\\"display: none;\\\">\\n    <span class=\\\"insert-option\\\" style=\\\"display: block;\\\">\\n      <label class=\\\"label\\\">INSERT</label>\\n      <a class=\\\"insert-action-text\\\">\\n        <i></i> Text</a>\\n      <a class=\\\"insert-action-media\\\">\\n        <i></i> Media</a>\\n      <a class=\\\"insert-action-product\\\">\\n        <i></i> Products</a>\\n    </span>\\n    <span class=\\\"insert-text\\\" style=\\\"display: none;\\\">\\n      <a href=\\\"#\\\" class=\\\"label\\\">TEXT</a>\\n      <a class=\\\"insert-action-text-body\\\">\\n        <i></i> Body</a>\\n      <a class=\\\"insert-action-text-quote\\\">\\n        <i></i> Quote</a>\\n    </span>\\n    <span class=\\\"insert-media\\\" style=\\\"display: none;\\\">\\n      <a href=\\\"#\\\" class=\\\"label\\\">MEDIA</a>\\n      <a class=\\\"insert-action-image\\\">\\n        <i></i> Images</a>\\n      <a class=\\\"insert-action-youtube\\\">\\n        <i></i> Youtube</a>\\n    </span>\\n    <span class=\\\"insert-image\\\" style=\\\"display: none;\\\">\\n      <a href=\\\"#\\\" class=\\\"label\\\">IMAGE</a>\\n      <a class=\\\"insert-action-image-single medium-insert-action\\\" data-addon=\\\"images\\\" data-action=\\\"add\\\" data-image-insert-type=\\\"single\\\">\\n        <i></i> Single</a>\\n      <a class=\\\"insert-action-image-slideshow gallery-insert-action\\\">\\n        <i></i> Slideshow</a>\\n      <a class=\\\"insert-action-image-grid medium-insert-action\\\" data-addon=\\\"images\\\" data-action=\\\"add\\\" data-meta='{ \\\"type\\\": \\\"grid\\\" }'>\\n        <i></i> Grid</a>\\n    </span>\\n    <span class=\\\"insert-product\\\" style=\\\"display: none;\\\">\\n      <a href=\\\"#\\\" class=\\\"label\\\">PRODUCT</a>\\n      <a class=\\\"insert-action-product-card\\\">\\n        <i></i> Cards</a>\\n      <a class=\\\"insert-action-product-slideshow\\\">\\n        <i></i> Slideshow</a>\\n    </span>\\n    <span class=\\\"insert-youtube\\\" style=\\\"display: none;\\\">\\n      <a href=\\\"#\\\" class=\\\"label\\\">YOUTUBE</a>\\n      <input class=\\\"extempt-dis-select\\\" type=\\\"text\\\" placeholder=\\\"Paste video link\\\">\\n      <button class=\\\"btns-green-embo\\\">Insert</button>\\n    </span>\\n    <span class=\\\"editable_tools\\\" style=\\\"display:none;\\\">\\n      <label class=\\\"label\\\">IMAGE STYLE</label>\\n      <a class=\\\"edit_full\\\">\\n        <i></i>\\n      </a>\\n      <a class=\\\"edit_normal\\\">\\n        <i></i>\\n      </a>\\n      <a class=\\\"edit_with_quote\\\">\\n        <i></i>\\n      </a>\\n    </span>\\n  </small>\\n  <button class=\\\"medium-insert-buttons-show show_option\\\" type=\\\"button\\\"></button>\\n</div>\\n\";\n},\"useData\":true});\n\nthis[\"MediumInsert\"][\"Templates\"][\"src/js/templates/core-buttons.hbs\"] = Handlebars.template({\"compiler\":[7,\">= 4.0.0\"],\"main\":function(container,depth0,helpers,partials,data) {\n    return \"<div class=\\\"add_option medium-insert-buttons\\\" contenteditable=\\\"false\\\" style=\\\"display: none\\\">\\n    <small class=\\\"add_option_tools\\\" style=\\\"display: none;\\\">\\n        <div class=\\\"trick\\\"></div>\\n        <a class=\\\"medium-insert-action\\\" data-addon=\\\"images\\\" data-action=\\\"add\\\">Insert Image</a>\\n        <a class=\\\"video-insert-action\\\">Insert Video</a>\\n        <a class=\\\"gallery-insert-action\\\">Insert Gallery</a>\\n    </small>\\n    <button class=\\\"medium-insert-buttons-show show_option\\\" type=\\\"button\\\"></button>\\n</div>\\n\";\n},\"useData\":true});\n\nthis[\"MediumInsert\"][\"Templates\"][\"src/js/templates/core-caption.hbs\"] = Handlebars.template({\"compiler\":[7,\">= 4.0.0\"],\"main\":function(container,depth0,helpers,partials,data) {\n    var helper;\n\n  return \"<figcaption contenteditable=\\\"true\\\" class=\\\"medium-insert-caption-placeholder\\\" data-placeholder=\\\"\"\n    + container.escapeExpression(((helper = (helper = helpers.placeholder || (depth0 != null ? depth0.placeholder : depth0)) != null ? helper : helpers.helperMissing),(typeof helper === \"function\" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{\"name\":\"placeholder\",\"hash\":{},\"data\":data}) : helper)))\n    + \"\\\"></figcaption>\";\n},\"useData\":true});\n\nthis[\"MediumInsert\"][\"Templates\"][\"src/js/templates/core-empty-line.hbs\"] = Handlebars.template({\"compiler\":[7,\">= 4.0.0\"],\"main\":function(container,depth0,helpers,partials,data) {\n    return \"<p><br></p>\\n\";\n},\"useData\":true});\n\nthis[\"MediumInsert\"][\"Templates\"][\"src/js/templates/embeds-toolbar.hbs\"] = Handlebars.template({\"1\":function(container,depth0,helpers,partials,data) {\n    var stack1;\n\n  return \"    <div class=\\\"medium-insert-embeds-toolbar medium-editor-toolbar medium-toolbar-arrow-under medium-editor-toolbar-active\\\">\\n        <ul class=\\\"medium-editor-toolbar-actions clearfix\\\">\\n\"\n    + ((stack1 = helpers.each.call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? depth0.styles : depth0),{\"name\":\"each\",\"hash\":{},\"fn\":container.program(2, data, 0),\"inverse\":container.noop,\"data\":data})) != null ? stack1 : \"\")\n    + \"        </ul>\\n    </div>\\n\";\n},\"2\":function(container,depth0,helpers,partials,data) {\n    var stack1;\n\n  return ((stack1 = helpers[\"if\"].call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? depth0.label : depth0),{\"name\":\"if\",\"hash\":{},\"fn\":container.program(3, data, 0),\"inverse\":container.noop,\"data\":data})) != null ? stack1 : \"\");\n},\"3\":function(container,depth0,helpers,partials,data) {\n    var stack1, helper, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=helpers.helperMissing, alias3=\"function\";\n\n  return \"                    <li>\\n                        <button class=\\\"medium-editor-action\\\" data-action=\\\"\"\n    + container.escapeExpression(((helper = (helper = helpers.key || (data && data.key)) != null ? helper : alias2),(typeof helper === alias3 ? helper.call(alias1,{\"name\":\"key\",\"hash\":{},\"data\":data}) : helper)))\n    + \"\\\">\"\n    + ((stack1 = ((helper = (helper = helpers.label || (depth0 != null ? depth0.label : depth0)) != null ? helper : alias2),(typeof helper === alias3 ? helper.call(alias1,{\"name\":\"label\",\"hash\":{},\"data\":data}) : helper))) != null ? stack1 : \"\")\n    + \"</button>\\n                    </li>\\n\";\n},\"5\":function(container,depth0,helpers,partials,data) {\n    var stack1;\n\n  return \"    <div class=\\\"medium-insert-embeds-toolbar2 medium-editor-toolbar medium-editor-toolbar-active\\\">\\n        <ul class=\\\"medium-editor-toolbar-actions clearfix\\\">\\n\"\n    + ((stack1 = helpers.each.call(depth0 != null ? depth0 : (container.nullContext || {}),(depth0 != null ? depth0.actions : depth0),{\"name\":\"each\",\"hash\":{},\"fn\":container.program(2, data, 0),\"inverse\":container.noop,\"data\":data})) != null ? stack1 : \"\")\n    + \"        </ul>\\n    </div>\\n\";\n},\"compiler\":[7,\">= 4.0.0\"],\"main\":function(container,depth0,helpers,partials,data) {\n    var stack1, alias1=depth0 != null ? depth0 : (container.nullContext || {});\n\n  return ((stack1 = helpers[\"if\"].call(alias1,(depth0 != null ? depth0.styles : depth0),{\"name\":\"if\",\"hash\":{},\"fn\":container.program(1, data, 0),\"inverse\":container.noop,\"data\":data})) != null ? stack1 : \"\")\n    + \"\\n\"\n    + ((stack1 = helpers[\"if\"].call(alias1,(depth0 != null ? depth0.actions : depth0),{\"name\":\"if\",\"hash\":{},\"fn\":container.program(5, data, 0),\"inverse\":container.noop,\"data\":data})) != null ? stack1 : \"\");\n},\"useData\":true});\n\nthis[\"MediumInsert\"][\"Templates\"][\"src/js/templates/embeds-wrapper.hbs\"] = Handlebars.template({\"compiler\":[7,\">= 4.0.0\"],\"main\":function(container,depth0,helpers,partials,data) {\n    var stack1, helper;\n\n  return \"<div class=\\\"medium-insert-embeds\\\" contenteditable=\\\"false\\\">\\n\t<figure>\\n\t\t<div class=\\\"medium-insert-embed\\\">\\n\t\t\t\"\n    + ((stack1 = ((helper = (helper = helpers.html || (depth0 != null ? depth0.html : depth0)) != null ? helper : helpers.helperMissing),(typeof helper === \"function\" ? helper.call(depth0 != null ? depth0 : (container.nullContext || {}),{\"name\":\"html\",\"hash\":{},\"data\":data}) : helper))) != null ? stack1 : \"\")\n    + \"\\n\t\t</div>\\n\t</figure>\\n\t<div class=\\\"medium-insert-embeds-overlay\\\"></div>\\n</div>\";\n},\"useData\":true});\n\nthis[\"MediumInsert\"][\"Templates\"][\"src/js/templates/images-fileupload.hbs\"] = Handlebars.template({\"compiler\":[7,\">= 4.0.0\"],\"main\":function(container,depth0,helpers,partials,data) {\n    return \"<input type=\\\"file\\\" multiple>\";\n},\"useData\":true});\n\nthis[\"MediumInsert\"][\"Templates\"][\"src/js/templates/images-grid-each.hbs\"] = Handlebars.template({\"1\":function(container,depth0,helpers,partials,data) {\n    return \"        <div class=\\\"medium-insert-images-progress\\\"></div>\\n\";\n},\"compiler\":[7,\">= 4.0.0\"],\"main\":function(container,depth0,helpers,partials,data) {\n    var stack1, helper, alias1=depth0 != null ? depth0 : (container.nullContext || {}), alias2=helpers.helperMissing, alias3=\"function\", alias4=container.escapeExpression;\n\n  return \"<div class=\\\"grid\\\" contenteditable=\\\"false\\\">\\n    <img src=\\\"/_ui/images/common/blank.gif\\\" data-src=\\\"\"\n    + alias4(((helper = (helper = helpers.img || (depth0 != null ? depth0.img : depth0)) != null ? helper : alias2),(typeof helper === alias3 ? helper.call(alias1,{\"name\":\"img\",\"hash\":{},\"data\":data}) : helper)))\n    + \"\\\" alt=\\\"\\\" class=\\\"\\\" style=\\\"background-image:url('\"\n    + alias4(((helper = (helper = helpers.img || (depth0 != null ? depth0.img : depth0)) != null ? helper : alias2),(typeof helper === alias3 ? helper.call(alias1,{\"name\":\"img\",\"hash\":{},\"data\":data}) : helper)))\n    + \"');\\\">\\n    <a href=\\\"#\\\" class=\\\"remove\\\">Remove</a>\\n    <a href=\\\"#\\\" class=\\\"btn-caption\\\">Add Caption</a>\\n    <figcaption contenteditable=\\\"true\\\" class=\\\"text-placeholder\\\" data-placeholder=\\\"Type an image caption\\\">\"\n    + alias4(((helper = (helper = helpers.caption || (depth0 != null ? depth0.caption : depth0)) != null ? helper : alias2),(typeof helper === alias3 ? helper.call(alias1,{\"name\":\"caption\",\"hash\":{},\"data\":data}) : helper)))\n    + \"</figcaption>\\n\"\n    + ((stack1 = helpers[\"if\"].call(alias1,(depth0 != null ? depth0.progress : depth0),{\"name\":\"if\",\"hash\":{},\"fn\":container.program(1, data, 0),\"inverse\":container.noop,\"data\":data})) != null ? stack1 : \"\")\n    + \"</div>\\n\";\n},\"useData\":true});\n\nthis[\"MediumInsert\"][\"Templates\"][\"src/js/templates/images-grid-popup.hbs\"] = Handlebars.template({\"compiler\":[7,\">= 4.0.0\"],\"main\":function(container,depth0,helpers,partials,data) {\n    return \"<small contenteditable=\\\"false\\\" class=\\\"add_option_tools _grid\\\" style=\\\"display:none;\\\">\\n    <a data-action=\\\"add\\\">Add images</a>\\n    <a data-action=\\\"organize\\\">Organize images</a>\\n    <a data-action=\\\"delete\\\">Delete Grid</a>\\n</small>\\n\";\n},\"useData\":true});\n\nthis[\"MediumInsert\"][\"Templates\"][\"src/js/templates/images-image.hbs\"] = Handlebars.template({\"1\":function(container,depth0,helpers,partials,data) {\n    return \"        <div class=\\\"medium-insert-images-progress\\\"></div>\\n\";\n},\"compiler\":[7,\">= 4.0.0\"],\"main\":function(container,depth0,helpers,partials,data) {\n    var stack1, helper, alias1=depth0 != null ? depth0 : (container.nullContext || {});\n\n  return \"<figure contenteditable=\\\"false\\\">\\n    <img src=\\\"\"\n    + container.escapeExpression(((helper = (helper = helpers.img || (depth0 != null ? depth0.img : depth0)) != null ? helper : helpers.helperMissing),(typeof helper === \"function\" ? helper.call(alias1,{\"name\":\"img\",\"hash\":{},\"data\":data}) : helper)))\n    + \"\\\" alt=\\\"\\\" />\\n\"\n    + ((stack1 = helpers[\"if\"].call(alias1,(depth0 != null ? depth0.progress : depth0),{\"name\":\"if\",\"hash\":{},\"fn\":container.program(1, data, 0),\"inverse\":container.noop,\"data\":data})) != null ? stack1 : \"\")\n    + \"</figure>\\n\";\n},\"useData\":true});\n\nthis[\"MediumInsert\"][\"Templates\"][\"src/js/templates/images-progressbar.hbs\"] = Handlebars.template({\"compiler\":[7,\">= 4.0.0\"],\"main\":function(container,depth0,helpers,partials,data) {\n    return \"<progress min=\\\"0\\\" max=\\\"100\\\" value=\\\"0\\\">0</progress>\";\n},\"useData\":true});\n\nthis[\"MediumInsert\"][\"Templates\"][\"src/js/templates/images-toolbar-gear.hbs\"] = Handlebars.template({\"compiler\":[7,\">= 4.0.0\"],\"main\":function(container,depth0,helpers,partials,data) {\n    return \"<div class=\\\"medium-insert-images-toolbar medium-editor-toolbar medium-toolbar-arrow-under medium-editor-toolbar-active\\\">\\n    <label class=\\\"label\\\">IMAGE STYLE</label>\\n    <div class=\\\"editable_tools\\\">\\n        <a class=\\\"edit_full\\\">Full</a>\\n        <a class=\\\"edit_normal\\\">Normal</a>\\n    </div>\\n</div>\\n\";\n},\"useData\":true});\n\nthis[\"MediumInsert\"][\"Templates\"][\"src/js/templates/images-toolbar.hbs\"] = Handlebars.template({\"compiler\":[7,\">= 4.0.0\"],\"main\":function(container,depth0,helpers,partials,data) {\n    return \"<div class=\\\"medium-insert-images-toolbar medium-editor-toolbar medium-toolbar-arrow-under medium-editor-toolbar-active\\\">\\n    <div class=\\\"editable_tools\\\">\\n        <a class=\\\"edit_full\\\">Full</a>\\n        <a class=\\\"edit_normal\\\">Normal</a>\\n        <a class=\\\"edit_with_quote\\\">With Quote</a>\\n    </div>\\n</div>\\n\";\n},\"useData\":true});\n\nthis[\"MediumInsert\"][\"Templates\"][\"src/js/templates/product-card.hbs\"] = Handlebars.template({\"compiler\":[7,\">= 4.0.0\"],\"main\":function(container,depth0,helpers,partials,data) {\n    return \"<ul class=\\\"itemList product\\\" contenteditable=\\\"false\\\">\\n  <% items.forEach(function(item, idx) { %>\\n  <li class=\\\"itemListElement\\\" data-id=\\\"<%= item.id %>\\\" data-idx=\\\"<%= idx %>\\\">\\n    <span class=\\\"figure <% if (item.image_fit_to_bounds) { %>fit<% } %>\\\">\\n      <img src=\\\"/_ui/images/common/blank.gif\\\" style=\\\"background-image:url(<%= item.image %>)\\\">\\n    </span>\\n    <span class=\\\"figcaption\\\">\\n      <span class=\\\"title\\\"><%= item.title %></span>\\n      <% if (item.retail_price != null) { %>\\n      <b class=\\\"price sales\\\">$<%= item.price %> <small class=\\\"before\\\">$<%= item.retail_price %></small></b>\\n      <% } else { %>\\n      <b class=\\\"price\\\">$<%= item.price %></b>\\n      <% } %>\\n    </span>\\n    <a class=\\\"remove\\\">Remove</a>\\n  </li>\\n  <% }); %>\\n  <small class=\\\"add_option_tools\\\" style=\\\"display:none;\\\">\\n    <a class=\\\"add-product\\\">Organize Products</a>\\n    <a class=\\\"delete-slideshow\\\">Delete Grid</a>\\n  </small>\\n</ul>\\n\";\n},\"useData\":true});\n\nthis[\"MediumInsert\"][\"Templates\"][\"src/js/templates/product-slideshow.hbs\"] = Handlebars.template({\"compiler\":[7,\">= 4.0.0\"],\"main\":function(container,depth0,helpers,partials,data) {\n    return \"<div class=\\\"itemSlide product\\\" contenteditable=\\\"false\\\">\\n  <div class=\\\"itemSlideWrap\\\">\\n    <ul class=\\\"stream after\\\">\\n      <% items.forEach(function(item, idx) { %>\\n      <li class=\\\"itemSlideElement\\\" data-id=\\\"<%= item.id %>\\\" data-idx=\\\"<%= idx %>\\\">\\n        <div class=\\\"figure-item\\\">\\n          <figure <% if (item.image_fit_to_bounds) { %>class=\\\"fit\\\"<% } %>>\\n            <a href=\\\"<% if (item.html_url) { %><%= item.html_url %><% } else { %>/sales/<%= item.id %>?utm=article<% } %>?utm=article\\\"><span\\n                class=\\\"back\\\"></span><img class=\\\"figure\\\" src=\\\"/_ui/images/common/blank.gif\\\" style=\\\"background-image: url(<%= item.image %>);\\\"></a>\\n          </figure>\\n          <figcaption>\\n            <span class=\\\"show_cart\\\">\\n              <button class=\\\"btn-cart nopopup soldout\\\">\\n                <% if (item.retail_price != null) { %><b class=\\\"price sales\\\">$<%= item.price %> <small class=\\\"before\\\">$<%= item.retail_price %></small></b><% } else { %><b class=\\\"price\\\">$<%= item.price %></b><% } %>\\n              </button>\\n            </span>\\n            <a href=\\\"<%= item.html_url %>?utm=article\\\" class=\\\"title\\\"><%= item.title %></a>\\n          </figcaption>\\n          <a class=\\\"delete\\\"></a>\\n        </div>\\n      </li>\\n      <% }); %>\\n    </ul>\\n  </div>\\n  <a href=\\\"#\\\" class=\\\"prev\\\">Prev</a>\\n  <a href=\\\"#\\\" class=\\\"next\\\">Next</a>\\n  <small class=\\\"add_option_tools\\\" style=\\\"display:none;\\\">\\n    <a class=\\\"add-product\\\">Organize Products</a>\\n    <a class=\\\"delete-slideshow\\\">Delete Slideshow</a>\\n  </small>\\n</div>\\n\";\n},\"useData\":true});\n;(function ($, window, document, undefined) {\n\n    'use strict';\n\n    /** Default values */\n    var pluginName = 'mediumInsert',\n        defaults = {\n            editor: null,\n            enabled: true,\n            addons: {\n                images: true, // boolean or object containing configuration\n                embeds: true\n            }\n        };\n\n    /**\n     * Capitalize first character\n     *\n     * @param {string} str\n     * @return {string}\n     */\n\n    function ucfirst(str) {\n        return str.charAt(0).toUpperCase() + str.slice(1);\n    }\n\n    // https://gist.github.com/yangshun/9892961#file-youtube-vimeo-url-parser-js-L24\n    function parseVideo (url) {\n        // - Supported YouTube URL formats:\n        //   - http://www.youtube.com/watch?v=My2FRPA3Gf8\n        //   - http://youtu.be/My2FRPA3Gf8\n        //   - https://youtube.googleapis.com/v/My2FRPA3Gf8\n        // - Supported Vimeo URL formats:\n        //   - http://vimeo.com/25451551\n        //   - http://player.vimeo.com/video/25451551\n        // - Also supports relative URLs:\n        //   - //player.vimeo.com/video/25451551\n\n        url.match(/(http:|https:|)\\/\\/(player.|www.)?(vimeo\\.com|youtu(be\\.com|\\.be|be\\.googleapis\\.com))\\/(video\\/|embed\\/|watch\\?v=|v\\/)?([A-Za-z0-9._%-]*)(\\&\\S+)?/);\n\n        if (RegExp.$3.indexOf('youtu') > -1) {\n            var type = 'youtube';\n        } else if (RegExp.$3.indexOf('vimeo') > -1) {\n            var type = 'vimeo';\n        }\n\n        return {\n            type: type,\n            id: RegExp.$6\n        };\n    }\n\n    /**\n     * Core plugin's object\n     *\n     * Sets options, variables and calls init() function\n     *\n     * @constructor\n     * @param {DOM} el - DOM element to init the plugin on\n     * @param {object} options - Options to override defaults\n     * @return {void}\n     */\n\n    function Core(el, options) {\n        var editor;\n\n        this.el = el;\n        this.$el = $(el);\n        this.templates = window.MediumInsert.Templates;\n\n        if (options) {\n            // Fix #142\n            // Avoid deep copying editor object, because since v2.3.0 it contains circular references which causes jQuery.extend to break\n            // Instead copy editor object to this.options manually\n            editor = options.editor;\n            options.editor = null;\n        }\n        this.options = $.extend(true, {}, defaults, options);\n        this.options.editor = editor;\n\n        this._defaults = defaults;\n        this._name = pluginName;\n\n        // Extend editor's functions\n        if (this.options && this.options.editor) {\n            if (this.options.editor._serialize === undefined) {\n                this.options.editor._serialize = this.options.editor.serialize;\n            }\n            if (this.options.editor._destroy === undefined) {\n                this.options.editor._destroy = this.options.editor.destroy;\n            }\n            if (this.options.editor._setup === undefined) {\n                this.options.editor._setup = this.options.editor.setup;\n            }\n            this.options.editor._hideInsertButtons = this.hideButtons;\n\n            this.options.editor.serialize = this.editorSerialize;\n            this.options.editor.destroy = this.editorDestroy;\n            this.options.editor.setup = this.editorSetup;\n\n            if (this.options.editor.getExtensionByName('placeholder') !== undefined) {\n                this.options.editor.getExtensionByName('placeholder').updatePlaceholder = this.editorUpdatePlaceholder;\n            }\n        }\n    }\n\n    /**\n     * Initialization\n     *\n     * @return {void}\n     */\n\n    function getAdjacentCursor($place) {\n        var $container = $('.description.more');\n        var isFirstChild = $place.is(':first-child');\n        var cursor;\n        if (isFirstChild) {\n            return { recoveryMode: 'insert-first' };\n        } else {\n            if ($place.is('.description.more > *')) {\n                cursor = $place.before();\n            } else {\n                cursor = $place.closest('.description.more > *').before();\n            }\n            return { recoveryMode: 'insert-next', cursor: cursor };\n        }\n    }\n\n    function restoreCursor(recoveryObject) {\n        var elToReplace = $('<p />')\n        if (recoveryObject.recoveryMode === 'insert-first') {\n            $('.description.more').prepend(elToReplace);\n        } else if (recoveryObject.recoveryMode === 'insert-next') {\n            elToReplace.insertAfter(recoveryObject.cursor);\n        } else {\n            console.warn(\"restoreCursor(): ?\")\n        }\n        return elToReplace;\n    }\n\n    Core.prototype.init = function () {\n        this.$el.addClass('medium-editor-insert-plugin');\n\n        if (typeof this.options.addons !== 'object' || Object.keys(this.options.addons).length === 0) {\n            this.disable();\n        }\n\n        this.initAddons();\n        this.clean();\n        this.events();\n\n        if (window.isWhitelabelV2) {\n            var productCardTemplate = _.template(this.templates['src/js/templates/product-card.hbs']().trim());\n            var productSlideshowTemplate = _.template(this.templates['src/js/templates/product-slideshow.hbs']().trim());\n            var $insertProductDialog = $.dialog('insert_product').$obj;\n            var selectedTemplate = _.template($insertProductDialog.find('#popup-tpl-selected').html())\n            var searchedTemplate = _.template($insertProductDialog.find('#popup-tpl-searched').html())\n            var $searched = $insertProductDialog.find('.suggest');\n            var $selected = $insertProductDialog.find('.featured');\n            Sortable.create($selected.find('ul').get(0), {\n                handle: '.btn-move',\n            });\n            \n            $insertProductDialog\n                .data('productCardTemplate', productCardTemplate)\n                .data('productSlideshowTemplate', productSlideshowTemplate);\n\n            var ThingCache = {};\n            window.ThingCache = ThingCache;\n            var searchCache = {};\n            var ref = { selectedItemIds: [] };\n\n            $insertProductDialog.find('input.text')\n                .on('keyup', _.debounce(function(e) {\n                    var val = e.target.value.trim();\n                    if (val === '') {\n                        $searched.hide();\n                        return;\n                    }\n                    var dfd;\n                    if (searchCache[val]) {\n                        dfd = $.Deferred();\n                        dfd.resolve(searchCache[val]);\n                    } else {\n                        dfd = $.get(window.REST_API_ENDPOINT, { keyword: val });\n                    }\n                    dfd.then(function(things) {\n                        if (!searchCache[val]) {\n                            searchCache[val] = things;\n                        }\n                        $searched.empty();\n                        if (things.products.length > 0) {\n                            $searched.show();\n                            things.products.forEach(function(thing) {\n                                var selected = _.find(ref.selectedItemIds, function(sid){ return thing.id === sid }) !== undefined;\n                                if (!selected) {\n                                    $searched.append($(searchedTemplate(thing)).data('thing', thing));\n                                    if (ThingCache[thing.id] == null) {\n                                        thing.cached = true;\n                                        ThingCache[thing.id] = thing;\n                                    }\n                                }\n                            });\n                        } else {\n                            $searched.hide();\n                        }\n                    })\n                    .fail(function(xhr) {\n                        if (xhr.status === 404) {\n                            alertify.alert('Product not found.');\n                        }\n                    })\n                }, 500))\n                .on('focus', function() {\n                    $(this).trigger('keyup');\n                });\n            $('.popup.insert_product .btn-save').on('click', function () {\n                var ids = $selected.find('li').map(function(i, e){ return Number($(e).attr('data-sid') || 0); }).toArray();\n                var items = ids.map(function(sid){ return ThingCache[sid]; });\n                // select template and feed context\n                var type = $insertProductDialog.data('type');\n                var tpl; \n                if (type === 'card') {\n                    tpl = productCardTemplate;\n                } else if (type === 'slideshow') {\n                    tpl = productSlideshowTemplate;\n                }\n                var $el = $(tpl({ items: items }));\n                $el.data('selectedItemIds', _.clone(ids));\n\n                var updatingRoot = $(this).data('updatingRoot');\n                // slideshow update mode\n                if (updatingRoot) {\n                    updatingRoot.replaceWith($el);\n                    $(this).data('updatingRoot', null);\n                } else {\n                    var $place = restoreCursor($insertProductDialog.data('cursor'));\n                    $place.replaceWith($el);\n                }\n\n                $.dialog('insert_product').close();\n            });\n\n            $searched.on('click', 'li', function(){\n                $searched.hide();\n                var thing = $(this).data('thing');\n                $selected.show();\n                // find dupe\n                var $dupe = $selected.find('ul li[data-sid=\"' + thing.id + '\"]')\n                if ($dupe.length > 0) {\n                    return;\n                }\n                ref.selectedItemIds.push(thing.id);\n                $selected.find('ul')\n                    .prepend(selectedTemplate(thing));\n                var cnt = ref.selectedItemIds.length;\n                $insertProductDialog.find('.btn-save')\n                    .attr('disabled', false)\n                    .text('Insert ' + cnt + (cnt === 1 ? ' Item' : ' Items'));\n            });\n\n            $selected.on('click', 'li .btn-del', function(){\n                var sidToDelete = Number($(this).closest('li').data('sid'));\n                $(this).closest('li').remove();\n                ref.selectedItemIds = ref.selectedItemIds.filter(function(sid) { return sid !== sidToDelete });\n                if (ref.selectedItemIds.length === 0) {\n                    $insertProductDialog.find('.btn-save').attr('disabled', true).text('Insert Items');\n                    $selected.hide();\n                }\n                var cnt = ref.selectedItemIds.length;\n                $insertProductDialog.find('.btn-save')\n                    .attr('disabled', false)\n                    .text('Insert ' + cnt + (cnt === 1 ? ' Item' : ' Items'));\n                return false;\n            });\n\n            $insertProductDialog.data('setSaved', function setSaved($root, _selectedItemIds) {\n                if (_selectedItemIds.length > 0) {\n                    // copy contents\n                    ref.selectedItemIds = _selectedItemIds;\n\n                    function jQueryPromiseAll(arrayOfPromises) {\n                        return jQuery.when.apply(jQuery, arrayOfPromises).then(function() {\n                            return Array.prototype.slice.call(arguments, 0);\n                        });\n                    }\n\n                    jQueryPromiseAll(_selectedItemIds.map(function(sid) {\n                        var promise = $.Deferred();\n                        if (ThingCache[sid]) {\n                            promise.resolve(ThingCache[sid]);\n                        } else {\n                            $.get('/rest-api/v1/things/' + sid + '?sales=true')\n                                .then(function(thing) {\n                                    var ctx;\n                                    try {\n                                        var image = (thing.sales.images[0] && thing.sales.images[0].src) || thing.image.src;\n                                        ctx = {\n                                            id: thing.sales.id,\n                                            brand_name: thing.sales.seller.brand_name,\n                                            title: thing.sales.title,\n                                            price: thing.sales.price,\n                                            thumbnail: image,\n                                            image: image,\n                                        }\n                                        ThingCache[thing.sales.id] = ctx;\n                                    } catch(e) {\n                                        ctx = {\n                                            id: '0',\n                                            brand_name: 'UNABLE_TO_LOAD',\n                                            title: 'UNABLE_TO_LOAD',\n                                            price: 0,\n                                            thumbnail: '/_ui/images/common/blank.gif',\n                                        };\n                                    }\n                                    promise.resolve(ctx);\n                                })\n                                .fail(function(xhr) {\n                                    console.warn('failed to load', sid, xhr);\n                                    promise.resolve({\n                                        id: '0',\n                                        brand_name: 'UNABLE_TO_LOAD',\n                                        title: 'UNABLE_TO_LOAD',\n                                        price: 0,\n                                        thumbnail: '/_ui/images/common/blank.gif',\n                                    });\n                                });\n                        }\n                        return promise\n                    })).then(function(args) {\n                        args.forEach(function(thing) {\n                            $selected.find('ul').append(selectedTemplate(thing));\n                        });\n                    })\n                    $selected.show();\n                    var cnt = _selectedItemIds.length;\n                    $insertProductDialog.find('.btn-save')\n                        .attr('disabled', false)    \n                        .text('Insert ' + cnt + (cnt === 1 ? ' Item' : ' Items'));\n                    $insertProductDialog.find('.btn-save').data('updatingRoot', $root);\n                }\n            })\n\n            // reset\n            $insertProductDialog.on('open', function() {\n                ref.selectedItemIds = [];\n                $insertProductDialog.find('input.text').val('');\n                $selected\n                    .find('ul').empty().end()\n                    .hide();\n                $searched.empty().hide();\n                $(this).find('.btn-save').attr('disabled', true).text('Insert Items');\n            });\n\n            // toggle button\n            setTimeout(function(t) {\n                t.clean();\n                t.positionButtons();\n                t.showButtons();\n                if (t.$el.find('.medium-insert-active').length === 0) {\n                    var activeInsertAdded = false;\n                    t.$el.find('> p').each(function(i, e) {\n                        if (activeInsertAdded) {\n                            return\n                        }\n                        if ($(e).text().trim() === '') {\n                            $(e).addClass('medium-insert-active')\n                            activeInsertAdded = true\n                        }\n                    });\n                }\n            }, 50, this);\n        } // if whitelabel v2 end\n    };\n\n    /**\n     * Event listeners\n     *\n     * @return {void}\n     */\n    Core.prototype.resetOptionV2 = function resetOptionV2() {\n        $('.add_option').hide();\n        $('.add_option_tools .insert-product, .add_option_tools .insert-text, .add_option_tools .insert-image, .add_option_tools .insert-media, .add_option_tools .insert-youtube').hide();\n        $('.add_option .insert-option').show();\n    }\n\n    Core.prototype.hideOptionPopupV2 = function hideOptionPopupV2() {\n        $('.medium-insert-buttons .add_option_tools').hide();\n        $('.medium-insert-buttons .add_option_tools .insert-product, .medium-insert-buttons .add_option_tools .insert-text, .medium-insert-buttons .add_option_tools .insert-image, .add_option_tools .insert-media, .add_option_tools .insert-youtube').hide();\n        $('.add_option .insert-option').show();\n    }\n\n    Core.prototype.events = function () {\n        var that = this;\n\n        function adjustCaretBeforeInsertWidget(root) {\n            var $place = root.$el.find('.medium-insert-active');\n            // From images.js \n            if ($place.is('p')) {\n                root.migrateExistingContent($place);\n                $place.replaceWith('<div class=\"medium-insert-active\">' + $place.html() + '</div>');\n                $place = root.$el.find('.medium-insert-active');\n                if ($place.next().is('p')) {\n                    root.moveCaret($place.next());\n                } else {\n                    $place.after('<p><br></p>'); // add empty paragraph so we can move the caret to the next line.\n                    root.moveCaret($place.next());\n                }\n            }\n            return $place;\n        }\n\n        function checkSelectionActive() {\n            if (that.$el.find('> .medium-insert-active').length === 0) {\n                var $anchorNode = $(document.getSelection().anchorNode)\n                if ($anchorNode.is('.description.more > *')) {\n                    $anchorNode.addClass('medium-insert-active');\n                }\n            }\n        }\n\n        function insertYoutubeOnEvent(that) {\n            var input = $('.insert-youtube input').val();\n            if (!input) {\n                return;\n            }\n            var vid = parseVideo(input.trim());\n            if (vid.type === 'youtube') { // youtube.com\n                var $place = that.$el.find('.medium-insert-active');\n                var $videoElement = $(`<p class=\"article-media media-youtube media-youtube-with-wrap\" data-service=\"youtube\" data-service-id=\"${vid.id}\" style=\"text-align: center;\"><span class=\"article-media-youtube-wrap\"><iframe src=\"https://www.youtube.com/embed/${vid.id}?\" width=\"100%\" height=\"100%\" frameborder=\"0\" allowfullscreen=\"allowfullscreen\"></iframe></span></p>`);\n                var $place = that.$el.find('.medium-insert-active');\n                if ($place.is('p')) {\n                    that.migrateExistingContent($place);\n                    $place.replaceWith('<div class=\"medium-insert-active\">' + $place.html() + '</div>');\n                    $place = that.$el.find('.medium-insert-active');\n                    if ($place.next().is('p')) {\n                        that.moveCaret($place.next());\n                    } else {\n                        $place.after('<p><br></p>'); // add empty paragraph so we can move the caret to the next line.\n                        that.moveCaret($place.next());\n                    }\n                    $place.replaceWith($videoElement);\n                    window.EditorControl.refresh();\n                }\n                return;\n            } else {\n                window.alert('Video service other than youtube is not supported.');\n                return;\n            }\n        }\n\n        this.$el\n            .on('dragover drop', function (e) {\n                e.preventDefault();\n            })\n            .on('keyup click focusout', $.proxy(this, 'toggleButtons'))\n            .on('selectstart mousedown', '.medium-insert, .medium-insert-buttons', $.proxy(this, 'disableSelection'))\n            .on('click', '> p', function() {\n                checkSelectionActive();\n            })\n            .on('click', '.medium-insert-buttons-show', function(e) {\n                var isVisible = $('.medium-insert-buttons .add_option_tools').is(':visible')\n                that.toggleAddons.call(that, e);\n                if (!isVisible) {\n                    setTimeout(function() {\n                        var mediumEditor = that.getEditor();\n                        var tb = mediumEditor.getExtensionByName('toolbar');\n                        if (tb && tb.isDisplayed()) {\n                            tb.hideToolbar();\n                        }\n                    }, 50)\n                }\n            })\n            .on('click', '.medium-insert-action', $.proxy(this, 'addonAction'))\n            .on('click', '.gallery-insert-action', (function(){ // #ARTICLE_MOD\n                checkSelectionActive();\n                var $place = adjustCaretBeforeInsertWidget(this);\n                if (!$place.get(0)) {\n                    return;\n                }\n                window.GalleryControl.uploadImages(function(nextImages) {\n                    if (nextImages === false) {\n                        alert('Failed to upload images, please try again'); return;\n                    } \n                    window.GalleryControl.renderTo($place, null, function(control) {\n                        control.instance.addImages(nextImages.filter(e => e));\n                        that.hideOptionPopupV2();\n                    });\n                });\n            }).bind(this))\n            .on('click', '.video-insert-action', (function(){ // #ARTICLE_MOD\n                var input = window.prompt('Please put youtube address');\n                if (input == null) {\n                    return;\n                }\n                var vid = parseVideo(input.trim());\n                if (vid.type === 'youtube') { // youtube.com\n                    var $videoElement = $(`<p class=\"article-media media-youtube\" data-service=\"youtube\" data-service-id=\"${vid.id}\" style=\"text-align: center;\"><iframe src=\"https://www.youtube.com/embed/${vid.id}?\" width=\"560\" height=\"315\" frameborder=\"0\" allowfullscreen=\"allowfullscreen\"></iframe></p>`);\n                    var $place = this.$el.find('.medium-insert-active');\n                    if ($place.is('p')) {\n                        this.migrateExistingContent($place);\n                        $place.replaceWith('<div class=\"medium-insert-active\">' + $place.html() + '</div>');\n                        $place = this.$el.find('.medium-insert-active');\n                        if ($place.next().is('p')) {\n                            this.moveCaret($place.next());\n                        } else {\n                            $place.after('<p><br></p>'); // add empty paragraph so we can move the caret to the next line.\n                            this.moveCaret($place.next());\n                        }\n                        $place.replaceWith($videoElement);\n                        window.EditorControl.refresh();\n                    }\n                    return;\n                } else {\n                    window.alert('Video service other than youtube is not supported.');\n                    return;\n                }\n            }).bind(this))\n            .on('click', '.medium-insert-buttons .trick', (function(e) { // #ARTICLE_MOD\n                if (!window.isWhitelabelV2) {\n                    this.$el.find('.add_option_tools').hide();\n                }\n            }).bind(this))\n            .on('paste', '.medium-insert-caption-placeholder', function (e) {\n                $.proxy(that, 'removeCaptionPlaceholder')($(e.target));\n            });\n        /*\n            Whitelabel V2 Stuff\n        */\n        if (isWhitelabelV2) {\n           this.$el\n           .on('click', '.insert-option .insert-action-text', function(){ // #ARTICLE_MOD\n                $('.add_option .insert-option').hide();\n                $('.add_option_tools .insert-text').show();\n                return false;\n            })\n            .on('click', '.insert-option .insert-action-media', function(){ // #ARTICLE_MOD\n                $('.add_option .insert-option').hide()\n                $('.add_option_tools .insert-media').show();\n                return false;\n            })\n            .on('click', '.insert-media .insert-action-image', function(){ // #ARTICLE_MOD\n                $('.add_option .insert-media').hide()\n                $('.add_option_tools .insert-image').show();\n                return false;\n            })\n            .on('click', '.insert-media .insert-action-youtube', function(){ // #ARTICLE_MOD\n                $('.add_option .insert-media').hide()\n                $('.add_option_tools .insert-youtube').show();\n                setTimeout(function() {\n                    $('.add_option_tools .insert-youtube input').focus();\n                }, 350)\n                return false;\n            })\n            .on('click', '.insert-youtube input', function() {\n                $(this).focus();\n                return true;\n            })\n            .on('focus', '.insert-youtube input', function() {\n                return true;\n            })\n            .on('mouseover', '.media-youtube', function(){\n                if ($(this).find('a.remove').length > 0) {\n                    $(this).find('a.remove').show();\n                } else {\n                    $(this).append('<a class=\"remove\" />');\n                }\n            })\n            .on('mouseout', '.media-youtube', function(){\n                if ($(this).find('a.remove').length > 0) {\n                    $(this).find('a.remove').hide();\n                }\n            })\n            .on('click', '.media-youtube .remove', function() {\n                $(this).closest('.media-youtube').remove();\n                return false;\n            })\n            .on('keydown', '.insert-youtube input', (function(e){ // #ARTICLE_MOD\n                if (e.which === 13) {\n                    insertYoutubeOnEvent(this);\n                    return false;\n                }\n                return true;\n            }).bind(this))\n            .on('click', '.insert-youtube button', (function(e){ // #ARTICLE_MOD\n                insertYoutubeOnEvent(this);\n                return true;\n            }).bind(this))\n            .on('click', '.insert-option .insert-action-product', function(){ // #ARTICLE_MOD\n                $('.add_option .insert-option').hide()\n                $('.add_option_tools .insert-product').show();\n                return false;\n            })\n            .on('click', '.insert-text .label', function(){ // #ARTICLE_MOD\n                $('.add_option_tools .insert-text').hide();\n                $('.add_option .insert-option').show();\n                return false;\n            })\n            .on('click', '.insert-media .label', function(){ // #ARTICLE_MOD\n                $('.add_option_tools .insert-media').hide();\n                $('.add_option .insert-option').show();\n                return false;\n            })\n            .on('click', '.insert-image .label', function(){ // #ARTICLE_MOD\n                $('.add_option_tools .insert-image').hide();\n                $('.add_option .insert-media').show();\n                return false;\n            })\n            .on('click', '.insert-youtube .label', function(){ // #ARTICLE_MOD\n                $('.add_option_tools .insert-youtube').hide();\n                $('.add_option .insert-media').show();\n                return false;\n            })\n            .on('click', '.insert-product .label', function(){ // #ARTICLE_MOD\n                $('.add_option_tools .insert-product').hide();\n                $('.add_option .insert-option').show();\n                return false;\n            })\n            // add text options\n            .on('click', '.insert-action-text-body', (function(){ // #ARTICLE_MOD\n                var $place = adjustCaretBeforeInsertWidget(this);\n                var $el = $('<p class=\"medium-insert-active\">Enter Body Text</p>')\n                $place.replaceWith($el);\n                this.moveCaret($el, $el.text().length);\n                that.hideOptionPopupV2();\n                return false;\n            }).bind(this))\n            .on('click', '.insert-action-text-quote', (function(){ // #ARTICLE_MOD\n                var $place = adjustCaretBeforeInsertWidget(this);\n                var $el = $('<blockquote class=\"medium-insert-active\"><span>Enter Quote Text</span></blockquote>')\n                $place.replaceWith($el);\n                this.moveCaret($el.find('span'), $el.find('span').text().length);\n                that.hideOptionPopupV2();\n                return false;\n            }).bind(this))\n            // add image options\n            .on('click', '.insert-action-image-single', function(){ // #ARTICLE_MOD\n                that.hideOptionPopupV2();\n                return false;\n            })\n            .on('click', '.insert-action-image-grid', function(){ // #ARTICLE_MOD\n                that.hideOptionPopupV2();\n                return false;\n            })\n            .on('click', '.insert-action-image-slideshow', function(){ // #ARTICLE_MOD\n                that.hideOptionPopupV2();\n                return false;\n            })\n            // add product card/slideshow\n            .on('click', '.insert-action-product-card', (function(){ // #ARTICLE_MOD\n                var $place = adjustCaretBeforeInsertWidget(this);\n                $.dialog('insert_product').$obj.data('cursor', getAdjacentCursor($place));\n                $.dialog('insert_product').$obj.data('type', 'card');\n                $.dialog('insert_product').open();\n                that.hideOptionPopupV2();\n                return false;\n            }).bind(this))\n            .on('click', '.insert-action-product-slideshow', (function(){ // #ARTICLE_MOD\n                var $place = adjustCaretBeforeInsertWidget(this);\n                $.dialog('insert_product').$obj.data('cursor', getAdjacentCursor($place));\n                $.dialog('insert_product').$obj.data('type', 'slideshow');\n                $.dialog('insert_product').open();\n                that.hideOptionPopupV2();\n                return false;\n            }).bind(this))\n            .on('mouseover', '.product, .medium-insert-images', function() {\n                $(this).find('.add_option_tools').show();\n            })\n            .on('mouseout', '.product, .medium-insert-images', function () {\n                $(this).find('.add_option_tools').hide();\n            })\n            .on('click', '.product .figure-item.add', function(){ // #ARTICLE_MOD\n                $(this).find('input').click();\n            })\n            .on('click', '.product .figure-item.add input, .product .add-product', function(){ // #ARTICLE_MOD\n                $.dialog('insert_product').open();\n                var isSlide = $(this).closest('.product').hasClass('itemSlide');\n                var isList = $(this).closest('.product').hasClass('itemList');\n                if (isSlide) {\n                    $.dialog('insert_product').$obj.data('type', 'slideshow')\n                } else if (isList) {\n                    $.dialog('insert_product').$obj.data('type', 'card')\n                }\n                // give time for reset\n                var $that = $(this);\n                setTimeout(function(){\n                    var selectedItemIds = $that.closest('.product').find('li').toArray()\n                    .sort(function(a, b) {\n                        return $(a).data('idx') - $(b).data('idx');\n                    }).map(function(e) {\n                        return $(e).data('id');\n                    });\n                    // rearrange the id that might shuffled by slide algo\n                    $that.closest('.product').data('selectedItemIds', selectedItemIds);\n                    $.dialog('insert_product').$obj.data('setSaved')($that.closest('.product'), selectedItemIds);\n                }, 50);\n                return false;\n            })\n            .one('click.initializeSlide', '.itemSlide .prev, .itemSlide .next', function(){\n                var $this = $(this);\n                var $slide = $this.closest('.product');\n                $slide.find('.itemSlide .prev, .itemSlide .next').off('click.initializeSlide');\n                $slide.productSlide({ itemPerSlide: 4, center: true })\n                setTimeout(function() {\n                    $this.click();\n                }, 500);\n                return false;\n            })\n            // .on('click', '.itemSlide .prev', function(){ // #ARTICLE_MOD\n            //     var $wrapper = $(this).closest('.product');\n            //     var len = $wrapper.find('li').length;\n            //     if (len <= 4) {\n            //         return false;\n            //     }\n            //     var si = $wrapper.data('slide-index');\n            //     if (si == null) {\n            //         si = 0;\n            //         $wrapper.data('slide-index', 0);\n            //     }\n            //     if (si === 0) {\n            //         return false;\n            //     }\n            //     $wrapper.find('.itemSlideWrap').css('transform', 'translateX(' + String((si - 1) * -95.5) + '%)');\n            //     $wrapper.data('slide-index', si - 1);\n            //     return false;\n            // })\n            // .on('click', '.itemSlide .next', function(){ // #ARTICLE_MOD\n            //     var $wrapper = $(this).closest('.product');\n            //     var len = $wrapper.find('li').length;\n            //     if (len <= 4) {\n            //         return false;\n            //     }\n            //     var si = $wrapper.data('slide-index');\n            //     if (si == null) {\n            //         si = 0;\n            //         $wrapper.data('slide-index', 0);\n            //     }\n            //     var max = Math.floor(len / 4);\n            //     if (si === max) {\n            //         return false;\n            //     }\n            //     $wrapper.find('.itemSlideWrap').css('transform', 'translateX(' + String((si + 1) * -95.5) + '%)');\n            //     $wrapper.data('slide-index', si + 1);\n            //     return false;\n            // })\n            // product card\n            .on('click', 'ul.itemList .itemListElement .remove', function(){\n                var $wrapper = $(this).closest('.product');\n                var selectedItemIds = $wrapper.data('selectedItemIds');\n                if (selectedItemIds == null) {\n                    selectedItemIds = $(this).closest('.product').find('li').map(function(i, e) {\n                        return $(e).data('id')\n                    }).toArray();\n                }\n                if (selectedItemIds.length <= 1) {\n                    $(this).closest('.itemList').remove();\n                    $wrapper.data('selectedItemIds', []);\n                } else {\n                    var $li = $(this).closest('.itemListElement');\n                    var removingId = $li.data('id');\n                    var next = selectedItemIds.filter(function(sid) { return sid !== removingId });\n                    $wrapper.data('selectedItemIds', next);\n                    $li.remove();\n                }\n            })\n            // product slideshow\n            .on('click', '.itemSlide li.itemSlideElement .delete', function(){\n                var $wrapper = $(this).closest('.product');\n                var selectedItemIds = $wrapper.data('selectedItemIds');\n                if (selectedItemIds == null) {\n                    selectedItemIds = $(this).closest('.product').find('li').map(function(i, e) {\n                        return $(e).data('id')\n                    }).toArray()\n                }\n                if (selectedItemIds.length <= 1) {\n                    $(this).closest('.itemSlide').remove();\n                } else {\n                    var $li = $(this).closest('.itemSlideElement');\n                    var removingId = $li.data('id');\n                    var next = selectedItemIds.filter(function(sid) { return sid !== removingId });\n                    $wrapper.data('selectedItemIds', next);\n                    $li.remove();\n                }\n            })\n            .on('click', '.itemList li.itemListElement .figure, .itemList li.itemListElement .figcaption', function(){\n                window.open('/sales/' + $(this).closest('.itemListElement').data('id'));\n            })\n            .on('click', '> p > a:not(.remove)', function(){\n                that.getEditor().selectElement(this);\n                that.getEditor().getExtensionByName('toolbar').showAndUpdateToolbar();\n                setTimeout(function() {\n                    $('.medium-editor-action-anchor2').click();\n                }, 50)\n            })\n            .on('click', '.product .delete-slideshow', function(){\n                $(this).closest('.product').remove();\n            });\n            $(document.body).on('click', function(e) {\n                if ($('.medium-insert-buttons .add_option_tools:visible').length !== 0 && \n                    $(e.target).closest('.add_option_tools, .show_option').length === 0) {\n                    that.hideOptionPopupV2();\n                }\n            })\n            /*\n            Whitelabel V2 Stuff END\n            */\n        } else {\n        }\n\n        $(window).on('resize', $.proxy(this, 'positionButtons', null));\n\n        // editor custom events\n        // var editor = this.getEditor();\n        // editor.subscribe('editableClick', function(a,b,c){\n        //     console.log('asdf')\n        // })\n    };\n\n    /**\n     * Return editor instance\n     *\n     * @return {object} MediumEditor\n     */\n\n    Core.prototype.getEditor = function () {\n        return this.options.editor;\n    };\n\n    /**\n     * Extend editor's serialize function\n     *\n     * @return {object} Serialized data\n     */\n\n    Core.prototype.editorSerialize = function () {\n        var data = this._serialize();\n\n        $.each(data, function (key) {\n            var $data = $('<div />').html(data[key].value);\n\n            $data.find('.medium-insert-buttons').remove();\n            $data.find('.medium-insert-active').removeClass('medium-insert-active');\n\n            // Restore original embed code from embed wrapper attribute value.\n            $data.find('[data-embed-code]').each(function () {\n                var $this = $(this),\n                    html = $('<div />').html($this.attr('data-embed-code')).text();\n                $this.html(html);\n            });\n\n            data[key].value = $data.html();\n        });\n\n        return data;\n    };\n\n    /**\n     * Extend editor's destroy function to deactivate this plugin too\n     *\n     * @return {void}\n     */\n\n    Core.prototype.editorDestroy = function () {\n        $.each(this.elements, function (key, el) {\n            if ($(el).data('plugin_' + pluginName) instanceof Core) {\n                $(el).data('plugin_' + pluginName).disable();\n            }\n        });\n\n        this._destroy();\n    };\n\n    /**\n     * Extend editor's setup function to activate this plugin too\n     *\n     * @return {void}\n     */\n\n    Core.prototype.editorSetup = function () {\n        this._setup();\n\n        $.each(this.elements, function (key, el) {\n            if ($(el).data('plugin_' + pluginName) instanceof Core) {\n                $(el).data('plugin_' + pluginName).enable();\n            }\n        });\n    };\n\n    /**\n     * Extend editor's placeholder.updatePlaceholder function to show placeholder dispite of the plugin buttons\n     *\n     * @return {void}\n     */\n\n    Core.prototype.editorUpdatePlaceholder = function (el, dontShow) {\n        var contents = $(el).children()\n            .not('.medium-insert-buttons, iframe').contents();\n\n        if (!dontShow && contents.length === 1 && contents[0].nodeName.toLowerCase() === 'br') {\n            this.showPlaceholder(el);\n            this.base._hideInsertButtons($(el));\n        } else {\n            this.hidePlaceholder(el);\n        }\n    };\n\n    /**\n     * Trigger editableInput on editor\n     *\n     * @return {void}\n     */\n\n    Core.prototype.triggerInput = function () {\n        if (this.getEditor()) {\n            this.getEditor().trigger('editableInput', null, this.el);\n        }\n    };\n\n    /**\n     * Deselects selected text\n     *\n     * @return {void}\n     */\n\n    Core.prototype.deselect = function () {\n        document.getSelection().removeAllRanges();\n    };\n\n    /**\n     * Disables the plugin\n     *\n     * @return {void}\n     */\n\n    Core.prototype.disable = function () {\n        this.options.enabled = false;\n\n        this.$el.find('.medium-insert-buttons').addClass('hide');\n    };\n\n    /**\n     * Enables the plugin\n     *\n     * @return {void}\n     */\n\n    Core.prototype.enable = function () {\n        this.options.enabled = true;\n\n        this.$el.find('.medium-insert-buttons').removeClass('hide');\n    };\n\n    /**\n     * Disables selectstart mousedown events on plugin elements except images\n     *\n     * @return {void}\n     */\n\n    Core.prototype.disableSelection = function (e) {\n        var $el = $(e.target);\n\n        if (($el.is('img') === false || $el.hasClass('medium-insert-buttons-show')) && !$el.hasClass('extempt-dis-select')) {\n            e.preventDefault();\n        }\n    };\n\n    /**\n     * Initialize addons\n     *\n     * @return {void}\n     */\n\n    Core.prototype.initAddons = function () {\n        var that = this;\n\n        if (!this.options.addons || this.options.addons.length === 0) {\n            return;\n        }\n\n        $.each(this.options.addons, function (addon, options) {\n            var addonName = pluginName + ucfirst(addon);\n\n            if (options === false) {\n                delete that.options.addons[addon];\n                return;\n            }\n\n            that.$el[addonName](options);\n            that.options.addons[addon] = that.$el.data('plugin_' + addonName).options;\n        });\n    };\n\n    /**\n     * Cleans a content of the editor\n     *\n     * @return {void}\n     */\n\n    Core.prototype.clean = function () {\n        var that = this,\n            $buttons, $lastEl, $text;\n\n        if (this.options.enabled === false) {\n            return;\n        }\n\n        if (this.$el.children().length === 0) {\n            this.$el.html(this.templates['src/js/templates/core-empty-line.hbs']().trim());\n        }\n\n        // Fix #29\n        // Wrap content text in <p></p> to avoid Firefox problems\n        $text = this.$el\n            .contents()\n            .filter(function () {\n                return (this.nodeName === '#text' && $.trim($(this).text()) !== '') || this.nodeName.toLowerCase() === 'br';\n            });\n\n        $text.each(function () {\n            $(this).wrap('<p />');\n\n            // Fix #145\n            // Move caret at the end of the element that's being wrapped\n            that.moveCaret($(this).parent(), $(this).text().length);\n        });\n\n        this.addButtons();\n\n        $buttons = this.$el.find('.medium-insert-buttons');\n        $lastEl = $buttons.prev();\n        if ($lastEl.attr('class') && $lastEl.attr('class').match(/medium\\-insert(?!\\-active)/)) {\n            $buttons.before(this.templates['src/js/templates/core-empty-line.hbs']().trim());\n        }\n    };\n\n    /**\n     * Returns HTML template of buttons\n     *\n     * @return {string} HTML template of buttons\n     */\n\n    Core.prototype.getButtons = function () {\n        if (this.options.enabled === false) {\n            return;\n        }\n        var templateName;\n        if (window.isWhitelabelV2) {\n            templateName = 'src/js/templates/core-buttons-gear.hbs'\n        } else {\n            templateName = 'src/js/templates/core-buttons.hbs'\n        }\n\n        return this.templates[templateName]({\n            addons: this.options.addons\n        }).trim();\n    };\n\n    /**\n     * Appends buttons at the end of the $el\n     *\n     * @return {void}\n     */\n\n    Core.prototype.addButtons = function () {\n        if (this.$el.find('.medium-insert-buttons').length === 0) {\n            var buttons = this.getButtons();\n            if (this.$el.find('.gallery-container').length > 0) {\n                buttons = $(buttons);\n                if (!window.isWhitelabelV2) {\n                    buttons.find('.gallery-insert-action').hide().end()\n                }\n                buttons = buttons.prop('outerHTML');\n            } else {\n                buttons = $(buttons).find('.gallery-insert-action').css('display', 'block').end().prop('outerHTML');\n            }\n            this.$el.append(buttons);\n        }\n    };\n\n    /**\n     * Move buttons to current active, empty paragraph and show them\n     *\n     * @return {void}\n     */\n\n    Core.prototype.toggleButtons = function (e) {\n        var $el = $(e.target),\n            selection = window.getSelection(),\n            that = this,\n            range, $current, $p, activeAddon;\n\n        if (this.options.enabled === false) {\n            return;\n        }\n\n        if (!selection || selection.rangeCount === 0) {\n            $current = $el;\n        } else {\n            range = selection.getRangeAt(0);\n            $current = $(range.commonAncestorContainer);\n        }\n\n        // When user clicks on  editor's placeholder in FF, $current el is editor itself, not the first paragraph as it should\n        if ($current.hasClass('medium-editor-insert-plugin')) {\n            $current = $current.find('p:first');\n        }\n\n        $p = $current.is('p') ? $current : $current.closest('p');\n\n        this.clean();\n\n        // console.log($el.hasClass('medium-editor-placeholder') === false)\n        // console.log($el.closest('.medium-insert-buttons').length === 0)\n        // console.log($current.closest('.medium-insert-buttons').length === 0)\n        \n        if (\n            $el.hasClass('medium-editor-placeholder') === false &&\n            $el.closest('.medium-insert-buttons').length === 0 && $current.closest('.medium-insert-buttons').length === 0) {\n\n            this.$el.find('.medium-insert-active').removeClass('medium-insert-active');\n\n            $.each(this.options.addons, function (addon) {\n                if ($el.closest('.medium-insert-' + addon).length) {\n                    $current = $el;\n                }\n\n                if ($current.closest('.medium-insert-' + addon).length) {\n                    $p = $current.closest('.medium-insert-' + addon);\n                    activeAddon = addon;\n                    return;\n                }\n            });\n\n            if ($p.length && ((/*$p.text().trim() === '' &&*/!activeAddon) || activeAddon === 'images')) {\n                $p.addClass('medium-insert-active');\n\n                if (activeAddon === 'images') {\n                    this.$el.find('.medium-insert-buttons').attr('data-active-addon', activeAddon);\n                } else {\n                    this.$el.find('.medium-insert-buttons').removeAttr('data-active-addon');\n                }\n\n                // If buttons are displayed on addon paragraph, wait 100ms for possible captions to display\n                setTimeout(function () {\n                    that.positionButtons(activeAddon);\n                    that.showButtons(activeAddon);\n                }, activeAddon ? 100 : 0);\n            } else {\n                this.hideButtons();\n            }\n        }\n    };\n\n    /**\n     * Show buttons\n     *\n     * @param {string} activeAddon - Name of active addon\n     * @returns {void}\n     */\n\n    Core.prototype.showButtons = function (activeAddon) {\n        var $buttons = this.$el.find('.medium-insert-buttons');\n\n        $buttons.show();\n        $buttons.find('li').show();\n\n        if (activeAddon) {\n            $buttons.find('li').hide();\n            $buttons.find('button[data-addon=\"' + activeAddon + '\"]').parent().show();\n        }\n    };\n\n    /**\n     * Hides buttons\n     *\n     * @param {jQuery} $el - Editor element\n     * @returns {void}\n     */\n\n    Core.prototype.hideButtons = function ($el) {\n        return; // #ARTICLE_MOD\n        $el = $el || this.$el;\n\n        $el.find('.medium-insert-buttons').hide();\n        $el.find('.medium-insert-buttons-addons').hide();\n        $el.find('.medium-insert-buttons-show').removeClass('medium-insert-buttons-rotate');\n    };\n\n    /**\n     * Position buttons\n     *\n     * @param {string} activeAddon - Name of active addon\n     * @return {void}\n     */\n\n    Core.prototype.positionButtons = function (activeAddon) {\n        var $buttons = this.$el.find('.medium-insert-buttons'),\n            $p = this.$el.find('.medium-insert-active'),\n            $lastCaption = $p.hasClass('medium-insert-images-grid') ? [] : $p.find('figure:last figcaption'),\n            elementsContainer = this.getEditor() ? this.getEditor().options.elementsContainer : $('body').get(0),\n            elementsContainerAbsolute = ['absolute', 'fixed'].indexOf(window.getComputedStyle(elementsContainer).getPropertyValue('position')) > -1,\n            position = { left: 75 }; // fixed 75px\n\n        if ($p.length) {\n            //position.left = $p.position().left;\n            position.top = $p.position().top;\n\n            if (activeAddon) {\n                //position.left += $p.width() - $buttons.find('.medium-insert-buttons-show').width() - 10;\n                position.top += $p.height() - 20 + ($lastCaption.length ? -$lastCaption.height() - parseInt($lastCaption.css('margin-top'), 10) : 10);\n            } else {\n                //position.left += -parseInt($buttons.find('.medium-insert-buttons-addons').css('left'), 10) - parseInt($buttons.find('.medium-insert-buttons-addons button:first').css('margin-left'), 10);\n                position.top += parseInt($p.css('margin-top'), 10);\n                position.top += parseInt($p.css('padding-top'), 10);\n            }\n\n            if (elementsContainerAbsolute) {\n                position.top += elementsContainer.scrollTop;\n            }\n\n            //if (this.$el.hasClass('medium-editor-placeholder') === false && position.left < 0) {\n            //    position.left = $p.position().left;\n            //}\n\n            $buttons.css(position);\n        }\n    };\n\n    /**\n     * Toggles addons buttons\n     *\n     * @return {void}\n     */\n\n    Core.prototype.toggleAddons = function () {\n        var $tools = this.$el.find('.add_option_tools');\n        $tools.toggle(); // #ARTICLE_MOD\n        var isVisible = $tools.is(':visible')\n        if (this.$el.find('.medium-insert-buttons').attr('data-active-addon') === 'images') {\n            this.$el.find('.medium-insert-buttons').find('button[data-addon=\"images\"]').click();\n            return;\n        }\n        //this.$el.find('.medium-insert-buttons-addons').fadeToggle(); // #ARTICLE_MOD\n        //this.$el.find('.medium-insert-buttons-show').toggleClass('medium-insert-buttons-rotate'); // #ARTICLE_MOD\n    };\n\n    /**\n     * Hide addons buttons\n     *\n     * @return {void}\n     */\n\n    Core.prototype.hideAddons = function () {\n        this.$el.find('.medium-insert-buttons-addons').hide();\n        this.$el.find('.medium-insert-buttons-show').removeClass('medium-insert-buttons-rotate');\n    };\n\n    /**\n     * Call addon's action\n     *\n     * @param {Event} e\n     * @return {void}\n     */\n\n    Core.prototype.addonAction = function (e) {\n        var $a = $(e.currentTarget),\n            addon = $a.data('addon'),\n            action = $a.data('action'),\n            meta = $a.data('meta');\n        this.$el.data('plugin_' + pluginName + ucfirst(addon))[action](meta);\n    };\n\n    /**\n     * Move caret at the beginning of the empty paragraph\n     *\n     * @param {jQuery} $el Element where to place the caret\n     * @param {integer} position Position where to move caret. Default: 0\n     *\n     * @return {void}\n     */\n\n    Core.prototype.moveCaret = function ($el, position) {\n        var range, sel, el, textEl;\n\n        position = position || 0;\n        range = document.createRange();\n        sel = window.getSelection();\n        el = $el.get(0);\n\n        if (!el.childNodes.length) {\n            textEl = document.createTextNode(' ');\n            el.appendChild(textEl);\n        }\n\n        range.setStart(el.childNodes[0], position);\n        range.collapse(true);\n        sel.removeAllRanges();\n        sel.addRange(range);\n    };\n\n    /**\n     * Add caption\n     *\n     * @param {jQuery Element} $el\n     * @param {string} placeholder\n     * @return {void}\n     */\n\n    Core.prototype.addCaption = function ($el, placeholder, text) {\n        var $caption = $el.find('figcaption');\n\n        if ($caption.length === 0) {\n            var $newCaption = $(this.templates['src/js/templates/core-caption.hbs']({\n                placeholder: placeholder\n            }));\n            if (text) {\n                $newCaption.removeAttr('data-placeholder');\n                $newCaption.attr('class', '');\n                $newCaption.text(text);\n            }\n            $el.append($newCaption);\n        }\n    };\n\n    /**\n     * Remove captions\n     *\n     * @param {jQuery Element} $ignore\n     * @return {void}\n     */\n\n    Core.prototype.removeCaptions = function ($ignore) {\n        var $captions = this.$el.find('figcaption');\n\n        if ($ignore) {\n            $captions = $captions.not($ignore);\n        }\n\n        $captions.each(function () {\n            if ($(this).hasClass('medium-insert-caption-placeholder') || $(this).text().trim() === '') {\n                $(this).remove();\n            }\n        });\n    };\n\n    /**\n     * Remove caption placeholder\n     *\n     * @param {jQuery Element} $el\n     * @return {void}\n     */\n\n    Core.prototype.removeCaptionPlaceholder = function ($el) {\n        var $caption = $el.is('figcaption') ? $el : $el.find('figcaption');\n\n        if ($caption.length) {\n            $caption\n                .removeClass('medium-insert-caption-placeholder')\n                .removeAttr('data-placeholder');\n        }\n    };\n\n    Core.prototype.migrateExistingContent = function migrateExistingContent($place) {\n        if ($place.text().length > 0) { // ARTICLE_MOD: move text before $place\n            var $cl = $place.clone();\n            $cl.insertBefore($place);\n            $cl.removeClass('medium-insert-active');\n            $place.html('');\n        }\n    };\n\n    /** Plugin initialization */\n\n    $.fn[pluginName] = function (options) {\n        return this.each(function () {\n            var that = this,\n                textareaId;\n\n            if ($(that).is('textarea')) {\n                textareaId = $(that).attr('medium-editor-textarea-id');\n                that = $(that).siblings('[medium-editor-textarea-id=\"' + textareaId + '\"]').get(0);\n            }\n\n            if (!$.data(that, 'plugin_' + pluginName)) {\n                // Plugin initialization\n                $.data(that, 'plugin_' + pluginName, new Core(that, options));\n                $.data(that, 'plugin_' + pluginName).init();\n            } else if (typeof options === 'string' && $.data(that, 'plugin_' + pluginName)[options]) {\n                // Method call\n                $.data(that, 'plugin_' + pluginName)[options]();\n            }\n        });\n    };\n\n})(jQuery, window, document);\n\n; (function ($, window, document, undefined) {\n\n    'use strict';\n\n    /** Default values */\n    var pluginName = 'mediumInsert',\n        addonName = 'Embeds', // first char is uppercase\n        defaults = {\n            label: '<span class=\"fa fa-youtube-play\"></span>',\n            placeholder: 'Paste a YouTube, Vimeo, Facebook, Twitter or Instagram link and press Enter',\n            oembedProxy: 'https://medium.iframe.ly/api/oembed?iframe=1',\n            captions: true,\n            captionPlaceholder: 'Type caption (optional)',\n            storeMeta: false,\n            styles: {\n                wide: {\n                    label: '<span class=\"fa fa-align-justify\"></span>'\n                    // added: function ($el) {},\n                    // removed: function ($el) {}\n                },\n                left: {\n                    label: '<span class=\"fa fa-align-left\"></span>'\n                    // added: function ($el) {},\n                    // removed: function ($el) {}\n                },\n                right: {\n                    label: '<span class=\"fa fa-align-right\"></span>'\n                    // added: function ($el) {},\n                    // removed: function ($el) {}\n                }\n            },\n            actions: {\n                remove: {\n                    label: '<span class=\"fa fa-times\"></span>',\n                    clicked: function () {\n                        var $event = $.Event('keydown');\n\n                        $event.which = 8;\n                        $(document).trigger($event);\n                    }\n                }\n            },\n            parseOnPaste: false\n        };\n\n    /**\n     * Embeds object\n     *\n     * Sets options, variables and calls init() function\n     *\n     * @constructor\n     * @param {DOM} el - DOM element to init the plugin on\n     * @param {object} options - Options to override defaults\n     * @return {void}\n     */\n\n    function Embeds(el, options) {\n        this.el = el;\n        this.$el = $(el);\n        this.templates = window.MediumInsert.Templates;\n        this.core = this.$el.data('plugin_' + pluginName);\n\n        this.options = $.extend(true, {}, defaults, options);\n\n        this._defaults = defaults;\n        this._name = pluginName;\n\n        // Extend editor's functions\n        if (this.core.getEditor()) {\n            this.core.getEditor()._serializePreEmbeds = this.core.getEditor().serialize;\n            this.core.getEditor().serialize = this.editorSerialize;\n        }\n\n        this.init();\n    }\n\n    /**\n     * Initialization\n     *\n     * @return {void}\n     */\n\n    Embeds.prototype.init = function () {\n        var $embeds = this.$el.find('.medium-insert-embeds');\n\n        $embeds.attr('contenteditable', false);\n        $embeds.each(function () {\n            if ($(this).find('.medium-insert-embeds-overlay').length === 0) {\n                $(this).append($('<div />').addClass('medium-insert-embeds-overlay'));\n            }\n        });\n\n        this.events();\n        this.backwardsCompatibility();\n    };\n\n    /**\n     * Event listeners\n     *\n     * @return {void}\n     */\n\n    Embeds.prototype.events = function () {\n        $(document)\n            .on('click', $.proxy(this, 'unselectEmbed'))\n            .on('keydown', $.proxy(this, 'removeEmbed'))\n            .on('click', '.medium-insert-embeds-toolbar .medium-editor-action', $.proxy(this, 'toolbarAction'))\n            .on('click', '.medium-insert-embeds-toolbar2 .medium-editor-action', $.proxy(this, 'toolbar2Action'));\n\n        this.$el\n            .on('keyup click paste', $.proxy(this, 'togglePlaceholder'))\n            .on('keydown', $.proxy(this, 'processLink'))\n            .on('click', '.medium-insert-embeds-overlay', $.proxy(this, 'selectEmbed'))\n            .on('contextmenu', '.medium-insert-embeds-placeholder', $.proxy(this, 'fixRightClickOnPlaceholder'));\n\n        if (this.options.parseOnPaste) {\n            this.$el\n                .on('paste', $.proxy(this, 'processPasted'));\n        }\n\n        $(window)\n            .on('resize', $.proxy(this, 'autoRepositionToolbars'));\n    };\n\n    /**\n     * Replace v0.* class names with new ones, wrap embedded content to new structure\n     *\n     * @return {void}\n     */\n\n    Embeds.prototype.backwardsCompatibility = function () {\n        var that = this;\n\n        this.$el.find('.mediumInsert-embeds')\n            .removeClass('mediumInsert-embeds')\n            .addClass('medium-insert-embeds');\n\n        this.$el.find('.medium-insert-embeds').each(function () {\n            if ($(this).find('.medium-insert-embed').length === 0) {\n                $(this).after(that.templates['src/js/templates/embeds-wrapper.hbs']({\n                    html: $(this).html()\n                }));\n                $(this).remove();\n            }\n        });\n    };\n\n    /**\n     * Extend editor's serialize function\n     *\n     * @return {object} Serialized data\n     */\n\n    Embeds.prototype.editorSerialize = function () {\n        var data = this._serializePreEmbeds();\n\n        $.each(data, function (key) {\n            var $data = $('<div />').html(data[key].value);\n\n            $data.find('.medium-insert-embeds').removeAttr('contenteditable');\n            $data.find('.medium-insert-embeds-overlay').remove();\n\n            data[key].value = $data.html();\n        });\n\n        return data;\n    };\n\n    /**\n     * Add embedded element\n     *\n     * @return {void}\n     */\n\n    Embeds.prototype.add = function () {\n        var $place = this.$el.find('.medium-insert-active');\n\n        // Fix #132\n        // Make sure that the content of the paragraph is empty and <br> is wrapped in <p></p> to avoid Firefox problems\n        $place.html(this.templates['src/js/templates/core-empty-line.hbs']().trim());\n\n        // Replace paragraph with div to prevent #124 issue with pasting in Chrome,\n        // because medium editor wraps inserted content into paragraph and paragraphs can't be nested\n        if ($place.is('p')) {\n            $place.replaceWith('<div class=\"medium-insert-active\">' + $place.html() + '</div>');\n            $place = this.$el.find('.medium-insert-active');\n            this.core.moveCaret($place);\n        }\n\n        $place.addClass('medium-insert-embeds medium-insert-embeds-input medium-insert-embeds-active');\n\n        this.togglePlaceholder({ target: $place.get(0) });\n\n        $place.click();\n        this.core.hideButtons();\n    };\n\n    /**\n     * Toggles placeholder\n     *\n     * @param {Event} e\n     * @return {void}\n     */\n\n    Embeds.prototype.togglePlaceholder = function (e) {\n        var $place = $(e.target),\n            selection = window.getSelection(),\n            range, $current, text;\n\n        if (!selection || selection.rangeCount === 0) {\n            return;\n        }\n\n        range = selection.getRangeAt(0);\n        $current = $(range.commonAncestorContainer);\n\n        if ($current.hasClass('medium-insert-embeds-active')) {\n            $place = $current;\n        } else if ($current.closest('.medium-insert-embeds-active').length) {\n            $place = $current.closest('.medium-insert-embeds-active');\n        }\n\n        if ($place.hasClass('medium-insert-embeds-active')) {\n\n            text = $place.text().trim();\n\n            if (text === '' && $place.hasClass('medium-insert-embeds-placeholder') === false) {\n                $place\n                    .addClass('medium-insert-embeds-placeholder')\n                    .attr('data-placeholder', this.options.placeholder);\n            } else if (text !== '' && $place.hasClass('medium-insert-embeds-placeholder')) {\n                $place\n                    .removeClass('medium-insert-embeds-placeholder')\n                    .removeAttr('data-placeholder');\n            }\n\n        } else {\n            this.$el.find('.medium-insert-embeds-active').remove();\n        }\n    };\n\n    /**\n     * Right click on placeholder in Chrome selects whole line. Fix this by placing caret at the end of line\n     *\n     * @param {Event} e\n     * @return {void}\n     */\n\n    Embeds.prototype.fixRightClickOnPlaceholder = function (e) {\n        this.core.moveCaret($(e.target));\n    };\n\n    /**\n     * Process link\n     *\n     * @param {Event} e\n     * @return {void}\n     */\n\n    Embeds.prototype.processLink = function (e) {\n        var $place = this.$el.find('.medium-insert-embeds-active'),\n            url;\n\n        if (!$place.length) {\n            return;\n        }\n\n        url = $place.text().trim();\n\n        // Return empty placeholder on backspace, delete or enter\n        if (url === '' && [8, 46, 13].indexOf(e.which) !== -1) {\n            $place.remove();\n            return;\n        }\n\n        if (e.which === 13) {\n            e.preventDefault();\n            e.stopPropagation();\n\n            if (this.options.oembedProxy) {\n                this.oembed(url);\n            } else {\n                this.parseUrl(url);\n            }\n        }\n    };\n\n    /**\n     * Process Pasted\n     *\n     * @param {Event} e\n     * @return {void}\n     */\n\n    Embeds.prototype.processPasted = function (e) {\n        var pastedUrl, linkRegEx;\n        if ($(\".medium-insert-embeds-active\").length) {\n            return;\n        }\n\n        pastedUrl = e.originalEvent.clipboardData.getData('text');\n        linkRegEx = new RegExp('^(http(s?):)?\\/\\/','i');\n        if (linkRegEx.test(pastedUrl)) {\n            if (this.options.oembedProxy) {\n                this.oembed(pastedUrl, true);\n            } else {\n                this.parseUrl(pastedUrl, true);\n            }\n        }\n    };\n\n    /**\n     * Get HTML via oEmbed proxy\n     *\n     * @param {string} url\n     * @return {void}\n     */\n\n    Embeds.prototype.oembed = function (url, pasted) {\n        var that = this;\n\n        $.support.cors = true;\n\n        $.ajax({\n            crossDomain: true,\n            cache: false,\n            url: this.options.oembedProxy,\n            dataType: 'json',\n            data: {\n                url: url\n            },\n            success: function (data) {\n                var html = data && data.html;\n\n                if (that.options.storeMeta) {\n                    html += '<div class=\"medium-insert-embeds-meta\"><script type=\"text/json\">' + JSON.stringify(data) + '</script></div>';\n                }\n\n                if (data && !html && data.type === 'photo' && data.url) {\n                    html = '<img src=\"' + data.url + '\" alt=\"\">';\n                }\n\n                if (!html) {\n                    // Prevent render empty embed.\n                    $.proxy(that, 'convertBadEmbed', url)();\n                    return;\n                }\n\n                if (pasted) {\n                    $.proxy(that, 'embed', html, url)();\n                } else {\n                    $.proxy(that, 'embed', html)();\n                }\n            },\n            error: function (jqXHR, textStatus, errorThrown) {\n                var responseJSON = (function () {\n                    try {\n                        return JSON.parse(jqXHR.responseText);\n                    } catch (e) { }\n                })();\n\n                if (typeof window.console !== 'undefined') {\n                    window.console.log((responseJSON && responseJSON.error) || jqXHR.status || errorThrown.message);\n                } else {\n                    window.alert('Error requesting media from ' + that.options.oembedProxy + ' to insert: ' + errorThrown + ' (response status: ' + jqXHR.status + ')');\n                }\n\n                $.proxy(that, 'convertBadEmbed', url)();\n            }\n        });\n    };\n\n    /**\n     * Get HTML using regexp\n     *\n     * @param {string} url\n     * @param {bool} pasted\n     * @return {void}\n     */\n\n    Embeds.prototype.parseUrl = function (url, pasted) {\n        var html;\n\n        if (!(new RegExp(['youtube', 'youtu.be', 'vimeo', 'instagram', 'twitter', 'facebook'].join('|')).test(url))) {\n            $.proxy(this, 'convertBadEmbed', url)();\n            return false;\n        }\n\n        html = url.replace(/\\n?/g, '')\n            .replace(/^((http(s)?:\\/\\/)?(www\\.)?(youtube\\.com|youtu\\.be)\\/(watch\\?v=|v\\/)?)([a-zA-Z0-9\\-_]+)(.*)?$/, '<div class=\"video video-youtube\"><iframe width=\"420\" height=\"315\" src=\"//www.youtube.com/embed/$7\" frameborder=\"0\" allowfullscreen></iframe></div>')\n            .replace(/^https?:\\/\\/vimeo\\.com(\\/.+)?\\/([0-9]+)$/, '<div class=\"video video-vimeo\"><iframe src=\"//player.vimeo.com/video/$2\" width=\"500\" height=\"281\" frameborder=\"0\" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div>')\n            .replace(/^https:\\/\\/twitter\\.com\\/(\\w+)\\/status\\/(\\d+)\\/?$/, '<blockquote class=\"twitter-tweet\" align=\"center\" lang=\"en\"><a href=\"https://twitter.com/$1/statuses/$2\"></a></blockquote><script async src=\"//platform.twitter.com/widgets.js\" charset=\"utf-8\"></script>')\n            .replace(/^(https:\\/\\/www\\.facebook\\.com\\/(.*))$/, '<script src=\"//connect.facebook.net/en_US/sdk.js#xfbml=1&amp;version=v2.2\" async></script><div class=\"fb-post\" data-href=\"$1\"><div class=\"fb-xfbml-parse-ignore\"><a href=\"$1\">Loading Facebook post...</a></div></div>')\n            .replace(/^https?:\\/\\/instagram\\.com\\/p\\/(.+)\\/?$/, '<span class=\"instagram\"><iframe src=\"//instagram.com/p/$1/embed/\" width=\"612\" height=\"710\" frameborder=\"0\" scrolling=\"no\" allowtransparency=\"true\"></iframe></span>');\n\n        if (this.options.storeMeta) {\n            html += '<div class=\"medium-insert-embeds-meta\"><script type=\"text/json\">' + JSON.stringify({}) + '</script></div>';\n        }\n\n        if ((/<(\"[^\"]*\"|'[^']*'|[^'\">])*>/).test(html) === false) {\n            $.proxy(this, 'convertBadEmbed', url)();\n            return false;\n        }\n\n        if (pasted) {\n            this.embed(html, url);\n        } else {\n            this.embed(html);\n        }\n    };\n\n    /**\n     * Add html to page\n     *\n     * @param {string} html\n     * @param {string} pastedUrl\n     * @return {void}\n     */\n\n    Embeds.prototype.embed = function (html, pastedUrl) {\n        var $place = this.$el.find('.medium-insert-embeds-active'),\n            $div;\n\n        if (!html) {\n            alert('Incorrect URL format specified');\n            return false;\n        } else {\n            if (html.indexOf('</script>') > -1) {\n                // Store embed code with <script> tag inside wrapper attribute value.\n                // Make nice attribute value escaping using jQuery.\n                $div = $('<div>')\n                    .attr('data-embed-code', $('<div />').text(html).html())\n                    .html(html);\n                html = $('<div>').append($div).html();\n            }\n\n            if (pastedUrl) {\n                // Get the element with the pasted url\n                // place the embed template and remove the pasted text\n                $place = this.$el.find(\":not(iframe, script, style)\")\n                    .contents().filter(\n                        function () {\n                            return this.nodeType === 3 && this.textContent.indexOf(pastedUrl) > -1;\n                        }).parent();\n\n                $place.after(this.templates['src/js/templates/embeds-wrapper.hbs']({\n                    html: html\n                }));\n                $place.text($place.text().replace(pastedUrl, ''));\n            } else {\n                $place.after(this.templates['src/js/templates/embeds-wrapper.hbs']({\n                    html: html\n                }));\n                $place.remove();\n            }\n\n\n            this.core.triggerInput();\n\n            if (html.indexOf('facebook') !== -1) {\n                if (typeof (FB) !== 'undefined') {\n                    setTimeout(function () {\n                        FB.XFBML.parse();\n                    }, 2000);\n                }\n            }\n        }\n    };\n\n    /**\n     * Convert bad oEmbed content to an actual line.\n     * Instead of displaying the error message we convert the bad embed\n     *\n     * @param {string} content Bad content\n     *\n     * @return {void}\n     */\n    Embeds.prototype.convertBadEmbed = function (content) {\n        var $place, $empty, $content,\n            emptyTemplate = this.templates['src/js/templates/core-empty-line.hbs']().trim();\n\n        $place = this.$el.find('.medium-insert-embeds-active');\n\n        // convert embed node to an empty node and insert the bad embed inside\n        $content = $(emptyTemplate);\n        $place.before($content);\n        $place.remove();\n        $content.html(content);\n\n        // add an new empty node right after to simulate Enter press\n        $empty = $(emptyTemplate);\n        $content.after($empty);\n\n        this.core.triggerInput();\n\n        this.core.moveCaret($empty);\n    };\n\n    /**\n     * Select clicked embed\n     *\n     * @param {Event} e\n     * @returns {void}\n     */\n\n    Embeds.prototype.selectEmbed = function (e) {\n        var that = this,\n            $embed;\n        if (this.core.options.enabled) {\n            $embed = $(e.target).hasClass('medium-insert-embeds') ? $(e.target) : $(e.target).closest('.medium-insert-embeds');\n\n            $embed.addClass('medium-insert-embeds-selected');\n\n            setTimeout(function () {\n                that.addToolbar();\n\n                if (that.options.captions) {\n                    that.core.addCaption($embed.find('figure'), that.options.captionPlaceholder);\n                }\n            }, 50);\n        }\n    };\n\n    /**\n     * Unselect selected embed\n     *\n     * @param {Event} e\n     * @returns {void}\n     */\n\n    Embeds.prototype.unselectEmbed = function (e) {\n        var $el = $(e.target).hasClass('medium-insert-embeds') ? $(e.target) : $(e.target).closest('.medium-insert-embeds'),\n            $embed = this.$el.find('.medium-insert-embeds-selected');\n\n        if ($el.hasClass('medium-insert-embeds-selected')) {\n            $embed.not($el).removeClass('medium-insert-embeds-selected');\n            $('.medium-insert-embeds-toolbar, .medium-insert-embeds-toolbar2').remove();\n            this.core.removeCaptions($el.find('figcaption'));\n\n            if ($(e.target).is('.medium-insert-caption-placeholder') || $(e.target).is('figcaption')) {\n                $el.removeClass('medium-insert-embeds-selected');\n                this.core.removeCaptionPlaceholder($el.find('figure'));\n            }\n            return;\n        }\n\n        $embed.removeClass('medium-insert-embeds-selected');\n        $('.medium-insert-embeds-toolbar, .medium-insert-embeds-toolbar2').remove();\n\n        if ($(e.target).is('.medium-insert-caption-placeholder')) {\n            this.core.removeCaptionPlaceholder($el.find('figure'));\n        } else if ($(e.target).is('figcaption') === false) {\n            this.core.removeCaptions();\n        }\n    };\n\n    /**\n     * Remove embed\n     *\n     * @param {Event} e\n     * @returns {void}\n     */\n\n    Embeds.prototype.removeEmbed = function (e) {\n        var $embed, $empty;\n\n        if (e.which === 8 || e.which === 46) {\n            $embed = this.$el.find('.medium-insert-embeds-selected');\n\n            if ($embed.length) {\n                e.preventDefault();\n\n                $('.medium-insert-embeds-toolbar, .medium-insert-embeds-toolbar2').remove();\n\n                $empty = $(this.templates['src/js/templates/core-empty-line.hbs']().trim());\n                $embed.before($empty);\n                $embed.remove();\n\n                // Hide addons\n                this.core.hideAddons();\n\n                this.core.moveCaret($empty);\n                this.core.triggerInput();\n            }\n        }\n    };\n\n    /**\n     * Adds embed toolbar to editor\n     *\n     * @returns {void}\n     */\n\n    Embeds.prototype.addToolbar = function () {\n        var $embed = this.$el.find('.medium-insert-embeds-selected'),\n            active = false,\n            $toolbar, $toolbar2, mediumEditor, toolbarContainer;\n\n        if ($embed.length === 0) {\n            return;\n        }\n\n        mediumEditor = this.core.getEditor();\n        toolbarContainer = mediumEditor.options.elementsContainer || 'body';\n\n        $(toolbarContainer).append(this.templates['src/js/templates/embeds-toolbar.hbs']({\n            styles: this.options.styles,\n            actions: this.options.actions\n        }).trim());\n\n        $toolbar = $('.medium-insert-embeds-toolbar');\n        $toolbar2 = $('.medium-insert-embeds-toolbar2');\n\n        $toolbar.find('button').each(function () {\n            if ($embed.hasClass('medium-insert-embeds-' + $(this).data('action'))) {\n                $(this).addClass('medium-editor-button-active');\n                active = true;\n            }\n        });\n\n        if (active === false) {\n            $toolbar.find('button').first().addClass('medium-editor-button-active');\n        }\n\n        this.repositionToolbars();\n        $toolbar.fadeIn();\n        $toolbar2.fadeIn();\n    };\n\n    Embeds.prototype.autoRepositionToolbars = function () {\n        setTimeout(function () {\n            this.repositionToolbars();\n            this.repositionToolbars();\n        }.bind(this), 0);\n    };\n\n    Embeds.prototype.repositionToolbars = function () {\n        var $toolbar = $('.medium-insert-embeds-toolbar'),\n            $toolbar2 = $('.medium-insert-embeds-toolbar2'),\n            $embed = this.$el.find('.medium-insert-embeds-selected'),\n            elementsContainer = this.core.getEditor().options.elementsContainer,\n            elementsContainerAbsolute = ['absolute', 'fixed'].indexOf(window.getComputedStyle(elementsContainer).getPropertyValue('position')) > -1,\n            elementsContainerBoundary = elementsContainerAbsolute ? elementsContainer.getBoundingClientRect() : null,\n            containerWidth = $(window).width(),\n            position = {};\n\n        if ($toolbar2.length) {\n            position.top = $embed.offset().top + 2; // 2px - distance from a border\n            position.left = $embed.offset().left + $embed.width() - $toolbar2.width() - 4; // 4px - distance from a border\n\n            if (elementsContainerAbsolute) {\n                position.top += elementsContainer.scrollTop - elementsContainerBoundary.top;\n                position.left -= elementsContainerBoundary.left;\n                containerWidth = $(elementsContainer).width();\n            }\n\n            if (position.left + $toolbar2.width() > containerWidth) {\n                position.left = containerWidth - $toolbar2.width();\n            }\n\n            $toolbar2.css(position);\n        }\n\n        if ($toolbar.length) {\n            position.left = $embed.offset().left + $embed.width() / 2 - $toolbar.width() / 2;\n            position.top = $embed.offset().top - $toolbar.height() - 8 - 2 - 5; // 8px - hight of an arrow under toolbar, 2px - height of an embed outset, 5px - distance from an embed\n\n            if (elementsContainerAbsolute) {\n                position.top += elementsContainer.scrollTop - elementsContainerBoundary.top;\n                position.left -= elementsContainerBoundary.left;\n            }\n\n            if (position.top < 0) {\n                position.top = 0;\n            }\n\n            $toolbar.css(position);\n        }\n    };\n\n    /**\n     * Fires toolbar action\n     *\n     * @param {Event} e\n     * @returns {void}\n     */\n\n    Embeds.prototype.toolbarAction = function (e) {\n        var $button = $(e.target).is('button') ? $(e.target) : $(e.target).closest('button'),\n            $li = $button.closest('li'),\n            $ul = $li.closest('ul'),\n            $lis = $ul.find('li'),\n            $embed = this.$el.find('.medium-insert-embeds-selected'),\n            that = this;\n\n        $button.addClass('medium-editor-button-active');\n        $li.siblings().find('.medium-editor-button-active').removeClass('medium-editor-button-active');\n\n        $lis.find('button').each(function () {\n            var className = 'medium-insert-embeds-' + $(this).data('action');\n\n            if ($(this).hasClass('medium-editor-button-active')) {\n                $embed.addClass(className);\n\n                if (that.options.styles[$(this).data('action')].added) {\n                    that.options.styles[$(this).data('action')].added($embed);\n                }\n            } else {\n                $embed.removeClass(className);\n\n                if (that.options.styles[$(this).data('action')].removed) {\n                    that.options.styles[$(this).data('action')].removed($embed);\n                }\n            }\n        });\n\n        this.core.triggerInput();\n    };\n\n    /**\n     * Fires toolbar2 action\n     *\n     * @param {Event} e\n     * @returns {void}\n     */\n\n    Embeds.prototype.toolbar2Action = function (e) {\n        var $button = $(e.target).is('button') ? $(e.target) : $(e.target).closest('button'),\n            callback = this.options.actions[$button.data('action')].clicked;\n\n        if (callback) {\n            callback(this.$el.find('.medium-insert-embeds-selected'));\n        }\n\n        this.core.triggerInput();\n    };\n\n    /** Plugin initialization */\n\n    $.fn[pluginName + addonName] = function (options) {\n        return this.each(function () {\n            if (!$.data(this, 'plugin_' + pluginName + addonName)) {\n                $.data(this, 'plugin_' + pluginName + addonName, new Embeds(this, options));\n            }\n        });\n    };\n\n})(jQuery, window, document);\n\n/*global MediumEditor*/\n\n// #ARTICLE_MOD\nvar ImageModes = {\n    Full: 'Full',\n    Normal: 'Normal',\n    Quoted: 'Quoted',\n    Grid: 'Grid',\n};\nvar ImageModesEditClasses = {\n    Full: 'edit_full',\n    Normal: 'edit_normal',\n    Quoted: 'edit_with_quote'\n};\nvar ImageModesClasses = {\n    Full: 'mode-full',\n    Normal: 'mode-normal',\n    Quoted: 'mode-quoted',\n    Grid: 'mode-grid',\n};\nvar quotedPlaceHolderMsg = 'Start typing or paste article text...';\n\n\n; (function ($, window, document, Util, undefined) {\n\n    'use strict';\n\n    /** Default values */\n    var pluginName = 'mediumInsert',\n        addonName = 'Images', // first char is uppercase\n        defaults = {\n            label: '<span class=\"fa fa-camera\"></span>',\n            deleteMethod: 'POST',\n            deleteScript: 'delete.php',\n            preview: true,\n            captions: true,\n            captionPlaceholder: 'Type caption for image (optional)',\n            autoGrid: 3,\n            fileUploadOptions: { // See https://github.com/blueimp/jQuery-File-Upload/wiki/Options\n                url: null,\n                acceptFileTypes: /(\\.|\\/)(gif|jpe?g|png)$/i\n            },\n            fileDeleteOptions: {},\n            styles: {\n                wide: {\n                    label: '<span class=\"fa fa-align-justify\"></span>'\n                    // added: function ($el) {},\n                    // removed: function ($el) {}\n                },\n                left: {\n                    label: '<span class=\"fa fa-align-left\"></span>'\n                    // added: function ($el) {},\n                    // removed: function ($el) {}\n                },\n                right: {\n                    label: '<span class=\"fa fa-align-right\"></span>'\n                    // added: function ($el) {},\n                    // removed: function ($el) {}\n                },\n                grid: {\n                    label: '<span class=\"fa fa-th\"></span>'\n                    // added: function ($el) {},\n                    // removed: function ($el) {}\n                }\n            },\n            actions: {\n                remove: {\n                    label: '<span class=\"fa fa-times\"></span>',\n                    clicked: function () {\n                        var $event = $.Event('keydown');\n\n                        $event.which = 8;\n                        $(document).trigger($event);\n                    }\n                }\n            },\n            sorting: function () {\n                var that = this;\n\n                $('.medium-insert-images').sortable({\n                    group: 'medium-insert-images',\n                    containerSelector: '.medium-insert-images',\n                    itemSelector: 'figure',\n                    placeholder: '<figure class=\"placeholder\">',\n                    handle: 'img',\n                    nested: false,\n                    vertical: false,\n                    afterMove: function () {\n                        that.core.triggerInput();\n                    }\n                });\n            },\n            messages: {\n                acceptFileTypesError: 'This file is not in a supported format: ',\n                maxFileSizeError: 'This file is too big: '\n            }\n            // uploadError: function($el, data) {}\n            // uploadCompleted: function ($el, data) {}\n        };\n\n    /**\n     * Images object\n     *\n     * Sets options, variables and calls init() function\n     *\n     * @constructor\n     * @param {DOM} el - DOM element to init the plugin on\n     * @param {object} options - Options to override defaults\n     * @return {void}\n     */\n\n    function Images(el, options) {\n        this.el = el;\n        this.$el = $(el);\n\n        // this.mode = this.$el.attr('data-mode') || ImageModes.Normal; // #ARTICLE_MOD\n\n        this.$currentImage = null;\n        this.templates = window.MediumInsert.Templates;\n        this.core = this.$el.data('plugin_' + pluginName);\n\n        this.options = $.extend(true, {}, defaults, options);\n\n        this._defaults = defaults;\n        this._name = pluginName;\n        this.meta = null; // should be set as null after use\n\n        // Allow image preview only in browsers, that support's that\n        if (this.options.preview && !window.FileReader) {\n            this.options.preview = false;\n        }\n\n        // Extend editor's functions\n        if (this.core.getEditor()) {\n            this.core.getEditor()._serializePreImages = this.core.getEditor().serialize;\n            this.core.getEditor().serialize = this.editorSerialize;\n        }\n\n        this.init();\n    }\n\n    /**\n     * Initialization\n     *\n     * @return {void}\n     */\n\n    function getImageMode($image) {\n        return $image.closest('figure').attr('data-mode');\n    }\n\n    Images.prototype.init = function () {\n        var $images = this.$el.find('.medium-insert-images');\n\n        $images.find('figcaption').attr('contenteditable', true);\n        $images.find('figure').attr('contenteditable', false);\n\n        this.events();\n        this.backwardsCompatibility();\n        this.sorting();\n    };\n\n    function changeMode($fig, prevMode, nextMode, tempCaptionCallback) {\n        $fig.attr('class', '');\n        $fig.addClass(ImageModesClasses[nextMode]);\n        $fig.attr('data-mode', nextMode);\n        $fig.attr('contenteditable', 'false');\n        var $caption = $fig.find('figcaption');\n        var tempCaption = '';\n        if ($caption.text().trim() !== '') {\n            tempCaption = $caption.text();\n        } else if (prevMode === ImageModes.Quoted) {\n            var quote = $fig.find('.textarea').text().trim();\n            if (quote) {\n                tempCaption = quote;\n            }\n        }\n\n        //this.core.removeCaptions(); // DIDNT WORK\n        if (tempCaption === '') {\n            $fig.find('figcaption').remove();\n        }\n\n        // Process figure when quote mode is related\n        if (nextMode === ImageModes.Quoted) {\n            $fig.find('figcaption').remove();\n            $fig.find('img')\n                .wrap('<p />')\n                .wrap('<span class=\"image\" />');\n            $fig\n                .append('<p contenteditable=\"true\" class=\"textarea\" data-changed=\"false\">' + quotedPlaceHolderMsg + '</p>');\n            if (tempCaption) {\n                $fig.find('.textarea')\n                    .text(tempCaption)\n                    .attr('data-changed', 'true');\n            }\n        } else if (prevMode === ImageModes.Quoted) {\n            var $img = $fig.find('img');\n            $fig.html('');\n            $fig.append($img);\n            if (tempCaption) {\n                tempCaptionCallback && tempCaptionCallback(tempCaption);\n            }\n        }\n    }\n    window.ReactMediumEditor__changeMode = changeMode;\n\n    Images.prototype.handleModeChange = function (nextMode) {\n        var prevMode = getImageMode(this.$currentImage);\n        if (prevMode === nextMode) { // no change in mode\n            return;\n        }\n        var $fig = this.$currentImage.closest('figure');\n        changeMode($fig, prevMode, nextMode, (function(tempCaption) {\n            this.core.addCaption($fig, this.options.captionPlaceholder, tempCaption);\n        }).bind(this));\n    };\n\n    /**\n     * Event listeners\n     *\n     * @return {void}\n     */\n\n    Images.prototype.events = function () {\n        var that = this;\n        $(document)\n            .on('click', $.proxy(this, 'unselectImage'))\n            .on('keydown', $.proxy(this, 'removeImage'))\n            .on('click', '.medium-insert-images.medium-insert-active .remove', (function(event) {\n                event.preventDefault();\n                var $this = $(event.currentTarget);\n                var $fig = $this.closest('.medium-insert-images figure');\n                if ($fig.attr('data-mode') === ImageModes.Grid) {\n                    $this.closest('.grid').remove();\n                } else {\n                    $fig.remove();\n                }\n            }).bind(this))\n            // Toolbar buttons.\n            .on('click', '.medium-insert-images-toolbar .edit_full', (function(event) {\n                this.handleModeChange(ImageModes.Full);\n            }).bind(this))\n            .on('click', '.medium-insert-images-toolbar .edit_normal', (function(event) {\n                this.handleModeChange(ImageModes.Normal);\n            }).bind(this))\n            .on('click', '.medium-insert-images-toolbar .edit_with_quote', (function(event) {\n                this.handleModeChange(ImageModes.Quoted);\n            }).bind(this))\n            // For serialization\n            .on('change', '.medium-insert-images figure textarea', (function(event) {\n                var $target = $(event.target);\n                $target.text($target.val());\n            }).bind(this))\n\n            .on('focusin', '.medium-editor-insert-plugin .medium-insert-images', function(event){\n                var el = event.target;\n                if (event.target.className === 'textarea') {\n                    if (el.getAttribute('data-changed') === 'false') {\n                        el.textContent = '';\n                    }\n                    $('.description.more').attr('data-disable-toolbar', 'true');\n                }\n            })\n            .on('keydown', '.medium-editor-insert-plugin .medium-insert-images', function(event){\n                var el = event.target;\n                if (event.target.className === 'textarea') {\n                    if (el.getAttribute('data-changed') !== 'true') {\n                        el.setAttribute('data-changed', 'true');\n                    }\n                }\n            })\n            .on('focusout', '.medium-editor-insert-plugin .medium-insert-images', function(event){\n                var el = event.target;\n                if (el.className === 'textarea') {\n                    $('.description.more').attr('data-disable-toolbar', null);\n                    if (el.textContent.trim() === '') {\n                        el.textContent = quotedPlaceHolderMsg;\n                        el.setAttribute('data-changed', 'false');\n                    }\n                }\n            })\n            .on('load', '.popup.insert_caption .figure img', function() {\n                $.dialog('insert_caption').center();\n            })\n            .on('click', '.medium-insert-images .grid .btn-caption', function(e) {\n                var epochId = 'gridimage-' + String(+new Date);\n                var popup = $.dialog('insert_caption');\n                var $grid = $(this).closest('.grid');\n                $grid.attr('id', epochId);\n                var src = $grid.find('img').attr('data-src');\n                popup.$obj.find('.figure img').attr('src', src);\n                popup.$obj.data('workingImage', epochId);\n                var caption = $grid.find('figcaption').text();\n                popup.$obj.find('textarea').val(caption);\n                popup.$obj.data('original', caption);\n                if (caption) {\n                    popup.$obj.find('.btn-remove').show()\n                } else {\n                    popup.$obj.find('.btn-remove').hide()\n                }\n                popup.open();\n                return false;\n            })\n            .on('click', '.medium-insert-images .add_option_tools._grid a', function() {\n                var action = $(this).data('action');\n                var $wrapper = $(this).closest('.medium-insert-images');\n                if (action === 'add') {\n                    window.GalleryControl.uploadImages(function(nextImages) {\n                        if (nextImages === false) {\n                            alert('Failed to upload images, please try again'); return;\n                        }\n                        // TODO\n                        nextImages.forEach(function (img) {\n                            var $img = $(that.templates['src/js/templates/images-grid-each.hbs']({\n                                img: img.image_url,\n                                progress: false,\n                                caption: '',\n                            }));\n                            $wrapper.find('figure').append($img);\n                        });\n                    })\n                } else if (action === 'organize') {\n                    var serialziedImages = $wrapper.find('.grid')\n                        .map(function(i, e) {\n                            return { id: i, url: $(e).find('img').data('src'), caption: $(e).find('figcaption').text() }\n                        }).toArray();\n                    organizeImageService.open(serialziedImages, function(organizedImages) {\n                        $wrapper.find('div.grid').remove()\n                        organizedImages.forEach(function(img) {\n                            var $img = $(that.templates['src/js/templates/images-grid-each.hbs']({\n                                img: img.url,\n                                progress: false,\n                                caption: img.caption,\n                            }));\n                            $wrapper.find('figure').append($img);\n                        });\n                    });\n                } else if (action === 'delete') {\n                    $wrapper.remove();\n                }\n            })\n            .on('click', '.popup.insert_caption .btn-save', function() {\n                var popup = $.dialog('insert_caption');\n                var epochId = popup.$obj.data('workingImage');\n                var original = popup.$obj.data('original');\n                var next = popup.$obj.find('textarea').val();\n                var $wrapper = $('#' + epochId);\n                var $cap = $wrapper.find('figcaption');\n                if (next !== original) {\n                    if ($cap.length === 0) {\n                        $cap = $('<figcaption contenteditable=\"true\" class=\"text-placeholder\" data-placeholder=\"Type caption for image (optional)\" />');\n                        $wrapper.append($cap);\n                    }\n                    $cap.text(next);\n                }\n                if ($cap.text() !== '') {\n                    $wrapper.find('.btn-caption').text('Edit Caption');\n                } else {\n                    $wrapper.find('.btn-caption').text('Add Caption');\n                }\n                popup.close();\n                return false;\n            })\n            .on('click', '.popup.insert_caption .btn-remove', function() {\n                var popup = $.dialog('insert_caption');\n                var epochId = popup.$obj.data('workingImage');\n                var $wrapper = $('#' + epochId);\n                $wrapper.find('figcaption').text('')\n                $wrapper.find('.btn-caption').text('Add Caption');\n                popup.close();\n                return false;\n            });\n\n        this.$el\n            .on('click', '.medium-insert-images img', $.proxy(this, 'selectImage'));\n\n        $(window)\n            .on('resize', $.proxy(this, 'autoRepositionToolbars'));\n    };\n\n    /**\n     * Replace v0.* class names with new ones\n     *\n     * @return {void}\n     */\n\n    Images.prototype.backwardsCompatibility = function () {\n        this.$el.find('.mediumInsert')\n            .removeClass('mediumInsert')\n            .addClass('medium-insert-images');\n\n        this.$el.find('.medium-insert-images.small')\n            .removeClass('small')\n            .addClass('medium-insert-images-left');\n    };\n\n    /**\n     * Extend editor's serialize function\n     *\n     * @return {object} Serialized data\n     */\n\n    Images.prototype.editorSerialize = function () {\n        var data = this._serializePreImages();\n\n        $.each(data, function (key) {\n            var $data = $('<div />').html(data[key].value);\n\n            $data.find('.medium-insert-images').find('figcaption, figure').removeAttr('contenteditable');\n            $data.find('.medium-insert-images-progress').remove();\n\n            data[key].value = $data.html();\n        });\n\n        return data;\n    };\n\n    /**\n     * Add image\n     *\n     * @return {void}\n     */\n\n    Images.prototype.add = function (meta) {\n        var that = this,\n            $file = $(this.templates['src/js/templates/images-fileupload.hbs']()),\n            fileUploadOptions = {\n                dataType: 'json',\n                add: function (e, data) {\n                    $.proxy(that, 'uploadAdd', e, data)();\n                },\n                done: function (e, data) {\n                    $.proxy(that, 'uploadDone', e, data)();\n                }\n            };\n        if (meta) {\n            this.meta = meta;\n        }\n\n        // Only add progress callbacks for browsers that support XHR2,\n        // and test for XHR2 per:\n        // http://stackoverflow.com/questions/6767887/\n        // what-is-the-best-way-to-check-for-xhr2-file-upload-support\n        if (new XMLHttpRequest().upload) {\n            fileUploadOptions.progress = function (e, data) {\n                $.proxy(that, 'uploadProgress', e, data)();\n            };\n\n            fileUploadOptions.progressall = function (e, data) {\n                $.proxy(that, 'uploadProgressall', e, data)();\n            };\n        }\n\n        $file.fileupload($.extend(true, {}, this.options.fileUploadOptions, fileUploadOptions));\n\n        $file.click();\n    };\n\n    /**\n     * Callback invoked as soon as files are added to the fileupload widget - via file input selection, drag & drop or add API call.\n     * https://github.com/blueimp/jQuery-File-Upload/wiki/Options#add\n     *\n     * @param {Event} e\n     * @param {object} data\n     * @return {void}\n     */\n\n    Images.prototype.uploadAdd = function (e, data) {\n        var $place = this.$el.find('.medium-insert-active'),\n            that = this,\n            uploadErrors = [],\n            file = data.files[0],\n            acceptFileTypes = this.options.fileUploadOptions.acceptFileTypes,\n            maxFileSize = this.options.fileUploadOptions.maxFileSize,\n            reader;\n\n        if (acceptFileTypes && !acceptFileTypes.test(file.type)) {\n            uploadErrors.push(this.options.messages.acceptFileTypesError + file.name);\n        } else if (maxFileSize && file.size > maxFileSize) {\n            uploadErrors.push(this.options.messages.maxFileSizeError + file.name);\n        }\n        if (uploadErrors.length > 0) {\n            if (this.options.uploadFailed && typeof this.options.uploadFailed === \"function\") {\n                this.options.uploadFailed(uploadErrors, data);\n\n                return;\n            }\n\n            alert(uploadErrors.join(\"\\n\"));\n\n            return;\n        }\n\n        this.core.hideButtons();\n\n        // Replace paragraph with div, because figure elements can't be inside paragraph\n        if ($place.is('p')) {\n            this.core.migrateExistingContent($place);\n            $place.replaceWith('<div class=\"medium-insert-active\">' + $place.html() + '</div>');\n            $place = this.$el.find('.medium-insert-active');\n            if ($place.next().is('p')) {\n                this.core.moveCaret($place.next());\n            } else {\n                $place.after('<p><br></p>'); // add empty paragraph so we can move the caret to the next line.\n                this.core.moveCaret($place.next());\n            }\n        }\n\n        $place.addClass('medium-insert-images');\n\n        if (this.options.preview === false && $place.find('progress').length === 0 && (new XMLHttpRequest().upload)) {\n            $place.append(this.templates['src/js/templates/images-progressbar.hbs']());\n        }\n\n        if (data.autoUpload || (data.autoUpload !== false && $(e.target).fileupload('option', 'autoUpload'))) {\n            data.process().done(function () {\n                // If preview is set to true, let the showImage handle the upload start\n                if (that.options.preview) {\n                    reader = new FileReader();\n\n                    reader.onload = function (e) {\n                        $.proxy(that, 'showImage', e.target.result, data)();\n                    };\n\n                    reader.readAsDataURL(data.files[0]);\n                } else {\n                    data.submit();\n                }\n            });\n        }\n    };\n\n    /**\n     * Callback for global upload progress events\n     * https://github.com/blueimp/jQuery-File-Upload/wiki/Options#progressall\n     *\n     * @param {Event} e\n     * @param {object} data\n     * @return {void}\n     */\n\n    Images.prototype.uploadProgressall = function (e, data) {\n        var progress, $progressbar;\n\n        if (this.options.preview === false) {\n            progress = parseInt(data.loaded / data.total * 100, 10);\n            $progressbar = this.$el.find('.medium-insert-active').find('progress');\n\n            $progressbar\n                .attr('value', progress)\n                .text(progress);\n\n            if (progress === 100) {\n                $progressbar.remove();\n            }\n        }\n    };\n\n    /**\n     * Callback for upload progress events.\n     * https://github.com/blueimp/jQuery-File-Upload/wiki/Options#progress\n     *\n     * @param {Event} e\n     * @param {object} data\n     * @return {void}\n     */\n\n    Images.prototype.uploadProgress = function (e, data) {\n        var progress, $progressbar;\n\n        if (this.options.preview) {\n            progress = 100 - parseInt(data.loaded / data.total * 100, 10);\n            $progressbar = data.context.find('.medium-insert-images-progress');\n\n            $progressbar.css('width', progress + '%');\n\n            if (progress === 0) {\n                $progressbar.remove();\n            }\n        }\n    };\n\n    /**\n     * Callback for successful upload requests.\n     * https://github.com/blueimp/jQuery-File-Upload/wiki/Options#done\n     *\n     * @param {Event} e\n     * @param {object} data\n     * @return {void}\n     */\n\n    Images.prototype.uploadDone = function (e, data) {\n        $.proxy(this, 'showImage', data.result.image_url, data, { uiid: data.result.id })(); // #ARTICLE_MOD\n\n        this.core.clean();\n        this.sorting();\n    };\n\n    /**\n     * Add uploaded / preview image to DOM\n     *\n     * @param {string} img\n     * @returns {void}\n     */\n\n    Images.prototype.showImage = function (img, data, additionals) { // #ARTICLE_MOD\n        window.__SECRET__ = window.__SECRET__ || {}; // #ARTICLE_MOD\n        window.__SECRET__.data = data; // #ARTICLE_MOD // TODO: fix data sharing somehow\n        var $place = this.$el.find('.medium-insert-active'),\n            domImage,\n            that;\n\n        // Hide editor's placeholder\n        $place.click();\n\n        // If preview is allowed and preview image already exists,\n        // replace it with uploaded image\n        that = this;\n        var isGrid = (this.options.autoGrid && $place.find('figure').length >= this.options.autoGrid) || this.meta && this.meta.type === 'grid';\n\n        if (this.options.preview && data.context) {\n            domImage = this.getDOMImage();\n            $(domImage).one('load', (function () {\n                var attr;\n                if (isGrid) {\n                    attr = 'data-src'\n                } else {\n                    attr = 'src'\n                }\n                data.context.find('img').attr(attr, img);\n\n                if (this.options.uploadCompleted) {\n                    this.options.uploadCompleted(data.context, data);\n                }\n\n                that.core.triggerInput();\n            }).bind(this));\n            if (isGrid) {\n                domImage.src = window.blankUrl;\n                $(domImage).css('background-image', 'url(' + img + ')');\n                if (img.indexOf('data:') === -1) {\n                    $(domImage).attr('data-src', img);\n                }\n                $(domImage).load();\n            } else {\n                domImage.src = img;\n            }\n        } else {\n            var expanded;\n            if (isGrid) {\n                expanded = $(this.templates['src/js/templates/images-grid-each.hbs']({\n                    img: img,\n                    progress: this.options.preview,\n                    caption: '',\n                }));\n                if ($place.find('figure').length === 0) {\n                    $place.append('<figure />')\n                }\n                data.context = expanded.appendTo($place.find('figure'));\n                $place.find('figure').attr('data-mode', ImageModes.Grid);\n            } else {\n                expanded = $(this.templates['src/js/templates/images-image.hbs']({\n                    img: img,\n                    progress: this.options.preview\n                }));\n                data.context = expanded.appendTo($place);\n                data.context.attr('data-mode', ImageModes.Normal);\n            }\n\n            var $img = data.context.find('img');\n            if (additionals && additionals.uiid) {\n                $img.attr('data-uiid', additionals.uiid); // #ARTICLE_MOD - Add ui.id for future use\n            }\n\n            $place.find('br').remove();\n\n            if (isGrid) {\n                $.each(this.options.styles, function (style, options) {\n                    var className = 'medium-insert-images-' + style;\n\n                    $place.removeClass(className);\n\n                    if (options.removed) {\n                        options.removed($place);\n                    }\n                });\n\n                if (!window.isWhitelabelV2) {\n                    $place.addClass('medium-insert-images-grid');\n                }\n\n                if (this.options.styles.grid.added) {\n                    this.options.styles.grid.added($place);\n                }\n                if ($place.find('.add_option_tools').length === 0) {\n                    var popup = this.templates['src/js/templates/images-grid-popup.hbs'];\n                    $place.find('figure').prepend(popup);\n                }\n            }\n\n            if (this.options.preview) {\n                data.submit();\n            } else if (this.options.uploadCompleted) {\n                this.options.uploadCompleted(data.context, data);\n            }\n        }\n\n        this.core.triggerInput();\n\n        return data.context;\n    };\n\n    Images.prototype.getDOMImage = function () {\n        return new window.Image();\n    };\n\n    /**\n     * Select clicked image\n     *\n     * @param {Event} e\n     * @returns {void}\n     */\n\n    Images.prototype.selectImage = function (e) {\n        var that = this,\n            $image;\n        \n        if (this.core.options.enabled) {\n            $image = $(e.target);\n            var isGrid = $image.closest('.grid').length > 0;\n            this.$currentImage = $image;\n\n            // Hide keyboard on mobile devices\n            this.$el.blur();\n\n            $image.addClass('medium-insert-image-active');\n            $image.closest('.medium-insert-images').addClass('medium-insert-active');\n\n            if (!isGrid) {\n                $(`<a href=\"#\" class=\"remove\">Remove</a>`).insertAfter($image)\n            }   \n\n            setTimeout(function () {\n                if (isGrid) {\n                    if (that.options.captions) {\n                        var $gridEach = $image.closest('div.grid');\n                        // if ($gridEach.find('figcaption').length === 0) {\n                        //     $gridEach.append('<figcaption contenteditable=\"true\" class=\"medium-insert-caption-placeholder text-placeholder\" data-placeholder=\"Type caption for image (optional)\" />')\n                        // }\n                    }\n                } else {\n                    that.addToolbar();\n\n                    if (that.options.captions && getImageMode(that.$currentImage) !== ImageModes.Quoted) {\n                        that.core.addCaption($image.closest('figure'), that.options.captionPlaceholder);\n                    }\n                }\n            }, 50);\n        }\n    };\n\n    /**\n     * Unselect selected image\n     *\n     * @param {Event} e\n     * @returns {void}\n     */\n\n    Images.prototype.unselectImage = function (e) {\n        if (this.$currentImage == null) {\n            return;\n        }\n        var $el;\n        if (e) {\n            $el = $(e.target);\n        } else {\n            $el = this.$currentImage.parent();\n        }\n\n        var $image = this.$el.find('.medium-insert-image-active');\n\n        if ($el.is(this.$currentImage)) {\n            return;\n        }\n\n        if ($el.is('img') && $el.hasClass('medium-insert-image-active')) {\n            $image.not($el).removeClass('medium-insert-image-active');\n            $('.medium-insert-images-toolbar, .medium-insert-images-toolbar2').remove();\n            this.core.removeCaptions($el);\n            return;\n        }\n\n        $image.removeClass('medium-insert-image-active');\n        $image.parent().find('.remove').remove();\n        $('.medium-insert-images-toolbar, .medium-insert-images-toolbar2').remove();\n\n        if ($el.is('.medium-insert-caption-placeholder')) {\n            this.core.removeCaptionPlaceholder($image.closest('figure'));\n        } else if ($el.is('figcaption') === false) {\n            if (this.$el.closest('figure').find('figcaption').text().trim()) {\n                this.core.removeCaptions();\n            }\n        }\n        this.$currentImage = null;\n    };\n\n    /**\n     * Remove image\n     *\n     * @param {Event} e\n     * @returns {void}\n     */\n\n    Images.prototype.removeImage = function (e) {\n        var images = [],\n            $selectedImage = this.$el.find('.medium-insert-image-active'),\n            $parent, $empty, selection, range, current, caretPosition, $current, $sibling, selectedHtml, i;\n\n        if (e.which === 8 || e.which === 46) {\n            if ($selectedImage.length) {\n                images.push($selectedImage);\n            }\n\n            // Remove image even if it's not selected, but backspace/del is pressed in text\n            selection = window.getSelection();\n            if (selection && selection.rangeCount) {\n                range = selection.getRangeAt(0);\n                current = range.commonAncestorContainer;\n                $current = current.nodeName === '#text' ? $(current).parent() : $(current);\n                caretPosition = MediumEditor.selection.getCaretOffsets(current).left;\n\n                // Is backspace pressed and caret is at the beginning of a paragraph, get previous element\n                if (e.which === 8 && caretPosition === 0) {\n                    $sibling = $current.prev();\n                // Is del pressed and caret is at the end of a paragraph, get next element\n                } else if (e.which === 46 && caretPosition === $current.text().length) {\n                    $sibling = $current.next();\n                }\n\n                if ($sibling && $sibling.hasClass('medium-insert-images')) {\n                    images.push($sibling.find('img'));\n                }\n\n                // If text is selected, find images in the selection\n                selectedHtml = MediumEditor.selection.getSelectionHtml(document);\n                if (selectedHtml) {\n                    $('<div></div>').html(selectedHtml).find('.medium-insert-images img').each(function () {\n                        images.push($(this));\n                    });\n                }\n            }\n\n            if (images.length) {\n                for (i = 0; i < images.length; i++) {\n                    //this.deleteFile(images[i].attr('src')); // #ARTICLE_MOD\n\n                    $parent = images[i].closest('.medium-insert-images');\n                    images[i].closest('figure').remove();\n\n                    if ($parent.find('figure').length === 0) {\n                        $empty = $parent.next();\n                        if ($empty.is('p') === false || $empty.text() !== '') {\n                            $empty = $(this.templates['src/js/templates/core-empty-line.hbs']().trim());\n                            $parent.before($empty);\n                        }\n                        $parent.remove();\n                    }\n                }\n\n                // Hide addons\n                this.core.hideAddons();\n                if (!selectedHtml && $empty) {\n                    e.preventDefault();\n                    this.core.moveCaret($empty);\n                }\n\n                $('.medium-insert-images-toolbar, .medium-insert-images-toolbar2').remove();\n                this.core.triggerInput();\n            }\n        }\n    };\n\n    /**\n     * Makes ajax call to deleteScript\n     *\n     * @param {String} file File name\n     * @returns {void}\n     */\n\n    Images.prototype.deleteFile = function (file) {\n        if (this.options.deleteScript) {\n            $.ajax($.extend(true, {}, {\n                url: this.options.deleteScript,\n                type: this.options.deleteMethod || 'POST',\n                data: { file: file }\n            }, this.options.fileDeleteOptions));\n        }\n    };\n\n    /**\n     * Adds image toolbar to editor\n     *\n     * @returns {void}\n     */\n\n    Images.prototype.addToolbar = function () {\n        var $image = this.$el.find('.medium-insert-image-active'),\n            $p = $image.closest('.medium-insert-images'),\n            active = false,\n            mediumEditor = this.core.getEditor(),\n            toolbarContainer = mediumEditor.options.elementsContainer || 'body',\n            $toolbar,\n            $toolbar2;\n\n        var $fig = $image.closest('figure');\n\n        var templateName = window.isWhitelabelV2 ? 'src/js/templates/images-toolbar-gear.hbs' :  'src/js/templates/images-toolbar.hbs';\n        var $tpl = this.templates[templateName]({\n            styles: this.options.styles,\n            actions: this.options.actions,\n        }).trim();\n\n        $(toolbarContainer).append(\n            $($tpl)\n                .find('.' + ImageModesEditClasses[getImageMode($fig)]).addClass('selected')\n                .end()\n        );\n\n        $toolbar = $('.medium-insert-images-toolbar');\n        $toolbar2 = $('.medium-insert-images-toolbar2');\n\n        $toolbar.find('button').each(function () {\n            if ($p.hasClass('medium-insert-images-' + $(this).data('action'))) {\n                $(this).addClass('medium-editor-button-active');\n                active = true;\n            }\n        });\n\n        if (active === false) {\n            $toolbar.find('button').first().addClass('medium-editor-button-active');\n        }\n\n        this.repositionToolbars();\n        this.core.getEditor().getExtensionByName('toolbar').hideToolbar();\n\n        $toolbar.fadeIn();\n        $toolbar2.fadeIn();\n    };\n\n    Images.prototype.autoRepositionToolbars = function () {\n        setTimeout(function () {\n            this.repositionToolbars();\n        }.bind(this), 0);\n    };\n\n    Images.prototype.repositionToolbars = function () {\n        var $toolbar = $('.medium-insert-images-toolbar'),\n            $toolbar2 = $('.medium-insert-images-toolbar2'),\n            $image = this.$el.find('.medium-insert-image-active'),\n            elementsContainer = this.core.getEditor().options.elementsContainer,\n            elementsContainerAbsolute = ['absolute', 'fixed'].indexOf(window.getComputedStyle(elementsContainer).getPropertyValue('position')) > -1,\n            elementsContainerBoundary = elementsContainerAbsolute ? elementsContainer.getBoundingClientRect() : null,\n            containerWidth = $(window).width(),\n            position = {};\n\n        if ($toolbar2.length) {\n            position.top = $image.offset().top + 2;\n            position.left = $image.offset().left + $image.width() - $toolbar2.width() - 4; // 4px - distance from a border\n\n            if (elementsContainerAbsolute) {\n                position.top += elementsContainer.scrollTop - elementsContainerBoundary.top;\n                position.left -= elementsContainerBoundary.left;\n                containerWidth = $(elementsContainer).width();\n            }\n\n            if (position.left + $toolbar2.width() > containerWidth) {\n                position.left = containerWidth - $toolbar2.width();\n            }\n\n            $toolbar2.css(position);\n        }\n\n        if ($toolbar.length) {\n            if ($image.closest('.medium-insert-images-grid-active').length) {\n                $image = $image.closest('.medium-insert-images-grid-active');\n            }\n\n            position.top = $image.offset().top - $toolbar.height() - 8 - 2 - 5; // 8px - hight of an arrow under toolbar, 2px - height of an image outset, 5px - distance from an image\n            position.left = $image.offset().left + $image.width() / 2 - $toolbar.width() / 2;\n\n            if (elementsContainerAbsolute) {\n                position.top += elementsContainer.scrollTop - elementsContainerBoundary.top;\n                position.left -= elementsContainerBoundary.left;\n            }\n\n            if (position.top < 0) {\n                position.top = 0;\n            }\n\n            $toolbar.css(position);\n        }\n    };\n\n    /**\n     * Fires toolbar action\n     *\n     * @param {Event} e\n     * @returns {void}\n     */\n\n    Images.prototype.toolbarAction = function (e) {\n        var that = this,\n            $button, $li, $ul, $lis, $p;\n\n        if (this.$currentImage === null) {\n            return;\n        }\n\n        $button = $(e.target).is('button') ? $(e.target) : $(e.target).closest('button');\n        $li = $button.closest('li');\n        $ul = $li.closest('ul');\n        $lis = $ul.find('li');\n        $p = this.$el.find('.medium-insert-active');\n\n        $button.addClass('medium-editor-button-active');\n        $li.siblings().find('.medium-editor-button-active').removeClass('medium-editor-button-active');\n\n        $lis.find('button').each(function () {\n            var className = 'medium-insert-images-' + $(this).data('action');\n\n            if ($(this).hasClass('medium-editor-button-active')) {\n                $p.addClass(className);\n\n                if (that.options.styles[$(this).data('action')].added) {\n                    that.options.styles[$(this).data('action')].added($p);\n                }\n            } else {\n                $p.removeClass(className);\n\n                if (that.options.styles[$(this).data('action')].removed) {\n                    that.options.styles[$(this).data('action')].removed($p);\n                }\n            }\n        });\n\n        this.core.hideButtons();\n\n        this.core.triggerInput();\n    };\n\n    /**\n     * Fires toolbar2 action\n     *\n     * @param {Event} e\n     * @returns {void}\n     */\n\n    Images.prototype.toolbar2Action = function (e) {\n        var $button, callback;\n\n        if (this.$currentImage === null) {\n            return;\n        }\n\n        $button = $(e.target).is('button') ? $(e.target) : $(e.target).closest('button');\n        callback = this.options.actions[$button.data('action')].clicked;\n\n        if (callback) {\n            callback(this.$el.find('.medium-insert-image-active'));\n        }\n\n        this.core.hideButtons();\n\n        this.core.triggerInput();\n    };\n\n    /**\n     * Initialize sorting\n     *\n     * @returns {void}\n     */\n\n    Images.prototype.sorting = function () {\n        $.proxy(this.options.sorting, this)();\n    };\n\n    /** Plugin initialization */\n\n    $.fn[pluginName + addonName] = function (options) {\n        return this.each(function () {\n            if (!$.data(this, 'plugin_' + pluginName + addonName)) {\n                $.data(this, 'plugin_' + pluginName + addonName, new Images(this, options));\n            }\n        });\n    };\n\n})(jQuery, window, document, MediumEditor.util);\n\n}));\n"],"sourceRoot":""}